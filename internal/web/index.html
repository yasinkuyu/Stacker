<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stacker - PHP Development Environment</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <style>
        :root {
            /* Light theme - improved contrast */
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8ec;
            --bg-hover: #d4d4d9;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #7a7a7a;
            --accent: #6366f1;
            --accent-hover: #5558d6;
            --accent-light: rgba(99, 102, 241, 0.15);
            --success: #059669;
            --success-bg: rgba(5, 150, 105, 0.15);
            --warning: #d97706;
            --warning-bg: rgba(217, 119, 6, 0.15);
            --danger: #dc2626;
            --danger-bg: rgba(220, 38, 38, 0.15);
            --border: #d4d4d9;
            --border-light: #e5e5ea;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-lg: rgba(0, 0, 0, 0.15);
            --gradient-start: #6366f1;
            --gradient-end: #8b5cf6;
        }

        [data-theme="dark"] {
            /* Dark theme - improved contrast */
            --bg-primary: #0a0a0f;
            --bg-secondary: #14141a;
            --bg-tertiary: #1e1e28;
            --bg-hover: #282835;
            --text-primary: #f0f0f5;
            --text-secondary: #b8b8c5;
            --text-muted: #6b6b7a;
            --accent: #818cf8;
            --accent-hover: #a5b4fc;
            --accent-light: rgba(129, 140, 248, 0.15);
            --success: #34d399;
            --success-bg: rgba(52, 211, 153, 0.15);
            --warning: #fbbf24;
            --warning-bg: rgba(251, 191, 36, 0.15);
            --danger: #f87171;
            --danger-bg: rgba(248, 113, 113, 0.15);
            --border: #2a2a3a;
            --border-light: #3a3a4a;
            --shadow: rgba(0, 0, 0, 0.4);
            --shadow-lg: rgba(0, 0, 0, 0.6);
            --gradient-start: #818cf8;
            --gradient-end: #a78bfa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
            line-height: 1.5;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-lg);
        }

        .logo-img {
            width: 36px;
            height: 36px;
            border-radius: 8px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        .logo-version {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-section {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 16px 16px 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            opacity: 0.8;
        }

        .nav-item.active .nav-icon {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 32px 40px;
            margin-left: 240px;
            min-height: 100vh;
            background: var(--bg-primary);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-lg);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .stat-icon.sites {
            background: var(--accent-light);
            color: var(--accent);
        }

        .stat-icon.services {
            background: var(--success-bg);
            color: var(--success);
        }

        .stat-icon.dumps {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .stat-icon.php {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 0;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s ease;
        }

        .list-item:hover {
            background: var(--bg-hover);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-primary {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .item-secondary {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-running {
            color: var(--success);
            background: var(--success-bg);
        }

        .status-stopped {
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-running .status-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-muted);
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.5;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn:hover {
            background: var(--accent-light);
            color: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white !important;
            font-weight: 600;
        }

        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 4px 12px var(--shadow-lg);
            transform: translateY(-2px);
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)) !important;
            color: white !important;
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--danger-bg);
        }

        .btn-success {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .btn-success:hover {
            background: var(--success);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--success-bg);
        }

        .btn-icon {
            width: 16px;
            height: 16px;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 0 24px;
            margin-bottom: 12px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-info {
            flex: 1;
        }

        .settings-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Toggle Switch */
        .toggle-switch {
            width: 52px;
            height: 28px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active::after {
            left: 26px;
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 12px;
        }

        .theme-btn {
            width: 44px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .theme-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px var(--shadow-lg);
        }

        .theme-btn:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Input */
        .input {
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding: 20px 24px;
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Footer */
        .sidebar-footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .server-status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Draw Panel - Slide-in Side Panel */
        .draw-panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .draw-panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .draw-panel {
            position: fixed;
            top: 0;
            right: -480px;
            width: 480px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
            box-shadow: -8px 0 32px var(--shadow-lg);
        }

        .draw-panel.open {
            right: 0;
        }

        .draw-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .draw-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .draw-panel-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--bg-hover);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .draw-panel-close:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .draw-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .draw-panel-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Service Card */
        .service-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .service-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--bg-tertiary);
        }

        .service-icon svg {
            width: 20px;
            height: 20px;
        }

        .service-icon.mysql {
            background: #00758f20;
            color: #00758f;
        }

        .service-icon.nginx {
            background: #00994420;
            color: #009944;
        }

        .service-icon.redis {
            background: #dc382d20;
            color: #dc382d;
        }

        .service-icon.php {
            background: #777bb420;
            color: #777bb4;
        }

        .service-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .service-port {
            font-size: 12px;
            color: var(--text-muted);
        }

        .service-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Site Row */
        .site-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s ease;
            gap: 16px;
        }

        .site-row:hover {
            background: var(--bg-hover);
        }

        .site-row:last-child {
            border-bottom: none;
        }

        .site-info {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .site-name {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .site-path {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .site-badges {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }

        .site-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .site-badge.php {
            background: rgba(119, 123, 180, 0.12);
            color: #777bb4;
            border: 1px solid rgba(119, 123, 180, 0.2);
        }

        .site-badge.ssl {
            background: rgba(52, 211, 153, 0.12);
            color: var(--success);
            border: 1px solid rgba(52, 211, 153, 0.2);
        }

        .site-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: var(--accent-light);
            color: var(--accent);
        }

        .icon-btn.danger:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .progress-container {
            margin-top: 24px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .progress-bar-bg {
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--primary);
        }

        .install-log {
            margin-top: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            max-height: 100px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* Slim Mode - Compact but readable */
        :root {
            --sidebar-width: 240px;
        }

        body[data-slim="true"] {
            --sidebar-width: 190px;
        }

        body[data-slim="true"] .sidebar {
            width: var(--sidebar-width);
            overflow-x: hidden;
        }

        body[data-slim="true"] .logo {
            padding: 16px 14px;
        }

        body[data-slim="true"] .logo-img {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        body[data-slim="true"] .logo-text {
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        body[data-slim="true"] .logo-version {
            font-size: 10px;
        }

        body[data-slim="true"] .main-content {
            margin-left: var(--sidebar-width);
            padding: 18px;
        }

        body[data-slim="true"] .page-header {
            margin-bottom: 16px;
        }

        body[data-slim="true"] .page-title {
            font-size: 20px;
        }

        body[data-slim="true"] .page-subtitle {
            font-size: 12px;
        }

        body[data-slim="true"] .stats-grid {
            gap: 12px;
        }

        body[data-slim="true"] .stat-card {
            padding: 14px;
            gap: 12px;
        }

        body[data-slim="true"] .stat-icon {
            width: 36px;
            height: 36px;
            padding: 9px;
        }

        body[data-slim="true"] .stat-icon svg {
            width: 18px;
            height: 18px;
        }

        body[data-slim="true"] .stat-label {
            font-size: 11px;
            margin-bottom: 3px;
        }

        body[data-slim="true"] .stat-value {
            font-size: 24px;
        }

        body[data-slim="true"] .card {
            margin-bottom: 14px;
        }

        body[data-slim="true"] .card-header {
            padding: 12px 14px;
        }

        body[data-slim="true"] .card-title {
            font-size: 13px;
            font-weight: 600;
        }

        body[data-slim="true"] .card-body {
            padding: 14px;
        }

        body[data-slim="true"] .list-item {
            padding: 10px 12px;
            gap: 12px;
        }

        body[data-slim="true"] .item-primary {
            font-size: 13px;
            font-weight: 500;
        }

        body[data-slim="true"] .item-secondary {
            font-size: 11px;
        }

        body[data-slim="true"] .site-row {
            padding: 10px 12px;
            gap: 12px;
        }

        body[data-slim="true"] .site-name {
            font-size: 14px;
        }

        body[data-slim="true"] .site-path {
            font-size: 11px;
        }

        body[data-slim="true"] .site-badge {
            padding: 3px 8px;
            font-size: 9px;
            border-radius: 8px;
        }

        body[data-slim="true"] .icon-btn {
            width: 28px;
            height: 28px;
        }

        body[data-slim="true"] .icon-btn svg {
            width: 13px;
            height: 13px;
        }

        body[data-slim="true"] .nav-item {
            padding: 10px 12px;
            font-size: 12px;
            gap: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        body[data-slim="true"] .nav-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        body[data-slim="true"] .nav-item span {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        body[data-slim="true"] .sidebar-footer {
            padding: 12px 14px;
        }

        body[data-slim="true"] .server-status {
            font-size: 11px;
            white-space: nowrap;
        }

        body[data-slim="true"] .server-status-dot {
            width: 7px;
            height: 7px;
            flex-shrink: 0;
        }

        body[data-slim="true"] .settings-row {
            padding: 12px 14px;
            gap: 12px;
        }

        body[data-slim="true"] .settings-label {
            font-size: 12px;
        }

        body[data-slim="true"] .settings-desc {
            font-size: 10px;
        }

        body[data-slim="true"] .settings-section-title {
            font-size: 11px;
            padding: 10px 14px;
        }

        body[data-slim="true"] .form-label {
            font-size: 12px;
            margin-bottom: 5px;
        }

        body[data-slim="true"] .form-hint {
            font-size: 10px;
            margin-top: 3px;
        }

        body[data-slim="true"] .input {
            padding: 9px 11px;
            font-size: 12px;
        }

        body[data-slim="true"] .form-select {
            padding: 9px 11px;
            font-size: 12px;
        }

        body[data-slim="true"] .toggle-switch {
            width: 38px;
            height: 22px;
            flex-shrink: 0;
        }

        body[data-slim="true"] .toggle-switch.active::after {
            left: 18px;
        }

        body[data-slim="true"] .draw-panel {
            width: 400px;
        }

        body[data-slim="true"] .draw-panel-header {
            padding: 12px 16px;
        }

        body[data-slim="true"] .draw-panel-title {
            font-size: 14px;
        }

        body[data-slim="true"] .draw-panel-body {
            padding: 14px;
        }

        body[data-slim="true"] .draw-panel-footer {
            padding: 12px 16px;
            gap: 10px;
        }

        body[data-slim="true"] .quick-actions {
            gap: 8px;
            flex-wrap: wrap;
        }

        body[data-slim="true"] .quick-actions .btn {
            padding: 8px 12px;
            font-size: 12px;
            gap: 7px;
        }

        body[data-slim="true"] .quick-actions .btn svg {
            width: 15px;
            height: 15px;
        }

        body[data-slim="true"] .status-badge {
            padding: 4px 8px;
            font-size: 10px;
            gap: 5px;
        }

        body[data-slim="true"] .status-dot {
            width: 6px;
            height: 6px;
        }

        body[data-slim="true"] .empty-state {
            padding: 36px 18px;
        }

        body[data-slim="true"] .empty-icon {
            width: 52px;
            height: 52px;
        }

        body[data-slim="true"] .empty-state p {
            font-size: 13px;
        }

        body[data-slim="true"] .progress-label {
            font-size: 12px;
        }

        body[data-slim="true"] .progress-bar-bg {
            height: 7px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">
                <img src="/logo.png" class="logo-img" alt="Stacker" onerror="this.style.display='none'">
                <div>
                    <div class="logo-text">Stacker</div>
                    <div class="logo-version">v1.0.0</div>
                </div>
            </div>

            <nav class="nav">
                <div class="nav-section">Overview</div>
                <button class="nav-item active" data-page="dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1" />
                        <rect x="14" y="3" width="7" height="7" rx="1" />
                        <rect x="3" y="14" width="7" height="7" rx="1" />
                        <rect x="14" y="14" width="7" height="7" rx="1" />
                    </svg>
                    <span>Dashboard</span>
                </button>

                <div class="nav-section">Development</div>
                <button class="nav-item" data-page="sites">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M2 12h20" />
                        <path
                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                    </svg>
                    <span>Sites</span>
                </button>
                <button class="nav-item" data-page="services">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                    </svg>
                    <span>Services</span>
                </button>
                <button class="nav-item" data-page="php">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <ellipse cx="12" cy="12" rx="10" ry="6" />
                        <path d="M6 12l2-4h2l-1 2h1l1-2h2l-2 4" />
                    </svg>
                    <span>PHP</span>
                </button>

                <div class="nav-section">Tools</div>
                <button class="nav-item" data-page="dumps">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg>
                    <span>Dumps</span>
                </button>
                <button class="nav-item" data-page="mail">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                        <polyline points="22,6 12,13 2,6" />
                    </svg>
                    <span>Mail</span>
                </button>
                <button class="nav-item" data-page="logs">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <path d="M14 2v6h6" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                    <span>Logs</span>
                </button>

                <div class="nav-section">System</div>
                <button class="nav-item" data-page="settings">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                    <span>Settings</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <div class="server-status">
                    <span class="server-status-dot"></span>
                    <span>Server running on :8080</span>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Overview of your development environment</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon sites">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M2 12h20" />
                            </svg>
                        </div>
                        <div class="stat-label">Sites</div>
                        <div class="stat-value" id="stat-sites">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon services">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                            </svg>
                        </div>
                        <div class="stat-label">Running Services</div>
                        <div class="stat-value" id="stat-services">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon dumps">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                        </div>
                        <div class="stat-label">Dumps</div>
                        <div class="stat-value" id="stat-dumps">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon php">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <ellipse cx="12" cy="12" rx="10" ry="6" />
                            </svg>
                        </div>
                        <div class="stat-label">PHP Version</div>
                        <div class="stat-value" id="stat-php">-</div>
                    </div>
                </div>

                <!-- Quick Access Grid -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Recent Sites -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Recent Sites</span>
                            <button class="btn" onclick="showPage('sites')"
                                style="padding: 6px 12px; font-size: 12px;">View All</button>
                        </div>
                        <div class="card-body" id="recent-sites" style="padding: 0;"></div>
                    </div>

                    <!-- Quick Services -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Services</span>
                            <button class="btn" onclick="showPage('services')"
                                style="padding: 6px 12px; font-size: 12px;">Manage</button>
                        </div>
                        <div class="card-body" id="quick-services" style="padding: 16px;"></div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Quick Actions</span>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="showPage('sites'); setTimeout(() => addSite(), 100)">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="12" y1="8" x2="12" y2="16" />
                                <line x1="8" y1="12" x2="16" y2="12" />
                            </svg>
                            Add New Site
                        </button>
                        <button class="btn btn-success" onclick="openTerminal()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="4 17 10 11 4 5" />
                                <line x1="12" y1="19" x2="20" y2="19" />
                            </svg>
                            Open Terminal
                        </button>
                        <button class="btn" onclick="location.reload()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="23 4 23 10 17 10" />
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                            </svg>
                            Refresh
                        </button>
                        <button class="btn" onclick="showPage('services')">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                            </svg>
                            Manage Services
                        </button>
                        <button class="btn" onclick="showPage('dumps')">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                            View Dumps
                        </button>
                        <button class="btn" onclick="showPage('mail')">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                <polyline points="22,6 12,13 2,6" />
                            </svg>
                            View Mail
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sites -->
            <div id="sites" class="page">
                <div class="page-header">
                    <h1 class="page-title">Sites</h1>
                    <p class="page-subtitle">Manage your local development sites</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Sites</span>
                        <button class="btn btn-primary" onclick="addSite()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            Add Site
                        </button>
                    </div>
                    <div class="card-body" id="sites-list"></div>
                </div>
            </div>

            <!-- Services -->
            <div id="services" class="page">
                <div class="page-header">
                    <h1 class="page-title">Services</h1>
                    <p class="page-subtitle">Manage database and cache services</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Services</span>
                    </div>
                    <div class="card-body" id="services-list"></div>
                </div>
            </div>

            <!-- Dumps -->
            <div id="dumps" class="page">
                <div class="page-header">
                    <h1 class="page-title">Dumps</h1>
                    <p class="page-subtitle">View debug dumps from your applications</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Dumps</span>
                        <button class="btn btn-danger" onclick="clearDumps()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="3 6 5 6 21 6" />
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                            </svg>
                            Clear All
                        </button>
                    </div>
                    <div class="card-body" id="dumps-list"></div>
                </div>
            </div>

            <!-- Mail -->
            <div id="mail" class="page">
                <div class="page-header">
                    <h1 class="page-title">Mail</h1>
                    <p class="page-subtitle">Captured emails from your applications</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Inbox</span>
                        <button class="btn btn-danger" onclick="clearMail()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="3 6 5 6 21 6" />
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                            </svg>
                            Clear All
                        </button>
                    </div>
                    <div class="card-body" id="mail-list"></div>
                </div>
            </div>

            <!-- Logs -->
            <div id="logs" class="page">
                <div class="page-header">
                    <h1 class="page-title">Logs</h1>
                    <p class="page-subtitle">View and search application logs</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Log Files</span>
                    </div>
                    <div class="card-body" id="logs-list"></div>
                </div>
            </div>

            <!-- PHP -->
            <div id="php" class="page">
                <div class="page-header">
                    <h1 class="page-title">PHP Versions</h1>
                    <p class="page-subtitle">Manage installed PHP versions</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Installed Versions</span>
                        <button class="btn btn-primary" onclick="openInstallPHP()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            Install PHP
                        </button>
                    </div>
                    <div class="card-body" id="php-list"></div>
                </div>
            </div>

            <!-- Settings -->
            <div id="settings" class="page">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                    <p class="page-subtitle">Configure your Stacker preferences</p>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Appearance</div>
                    <div class="card">
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Theme</div>
                                <div class="settings-desc">Choose between light and dark mode</div>
                            </div>
                            <div class="theme-toggle">
                                <button class="theme-btn" data-theme="light" onclick="setTheme('light')"
                                    title="Light Mode">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        width="18" height="18">
                                        <circle cx="12" cy="12" r="5" />
                                        <line x1="12" y1="1" x2="12" y2="3" />
                                        <line x1="12" y1="21" x2="12" y2="23" />
                                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                                        <line x1="1" y1="12" x2="3" y2="12" />
                                        <line x1="21" y1="12" x2="23" y2="12" />
                                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                                    </svg>
                                </button>
                                <button class="theme-btn active" data-theme="dark" onclick="setTheme('dark')"
                                    title="Dark Mode">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        width="18" height="18">
                                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Slim Mode</div>
                                <div class="settings-desc">Compact layout with reduced spacing</div>
                            </div>
                            <button class="toggle-switch" id="slim-mode-toggle" onclick="toggleSlimMode()"></button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Startup</div>
                    <div class="card">
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Auto-start on login</div>
                                <div class="settings-desc">Start Stacker automatically when you log in to your Mac</div>
                            </div>
                            <button class="toggle-switch" id="auto-start-toggle" onclick="toggleAutoStart()"></button>
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Show in System Tray</div>
                                <div class="settings-desc">Keep Stacker icon visible in the menu bar</div>
                            </div>
                            <button class="toggle-switch active" id="tray-toggle" onclick="toggleTray()"></button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Server</div>
                    <div class="card">
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Web UI Port</div>
                                <div class="settings-desc">Port for the web dashboard (requires restart)</div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="number" id="port-input" class="input" value="8080" min="1024" max="65535"
                                    style="width: 100px;">
                                <button class="btn btn-primary" onclick="savePort()">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">About</div>
                    <div class="card">
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Stacker</div>
                                <div class="settings-desc">Version 1.0.0  PHP Development Environment</div>
                            </div>
                            <button class="btn" onclick="checkUpdates()">Check for Updates</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toast-message"></span>
    </div>

    <!-- Draw Panel Overlay -->
    <div class="draw-panel-overlay" id="drawPanelOverlay" onclick="closeDrawPanel()"></div>

    <!-- Draw Panel -->
    <div class="draw-panel" id="drawPanel">
        <div class="draw-panel-header">
            <span class="draw-panel-title" id="drawPanelTitle">Panel</span>
            <button class="draw-panel-close" onclick="closeDrawPanel()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>
        <div class="draw-panel-body" id="drawPanelBody">
            <!-- Dynamic content -->
        </div>
        <div class="draw-panel-footer" id="drawPanelFooter">
            <button class="btn" onclick="closeDrawPanel()">Cancel</button>
            <button class="btn btn-primary" id="drawPanelSave">Save</button>
        </div>
    </div>

    <script>
        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => showPage(item.dataset.page));
        });

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelector('[data-page="' + pageId + '"]').classList.add('active');
            loadPage(pageId);
        }

        // API Helper
        async function api(endpoint, method = 'GET', data = null) {
            try {
                const options = { method };
                if (data) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(data);
                }
                const res = await fetch('/api' + endpoint, options);
                return res.json();
            } catch (err) {
                console.error('API Error:', err);
                return null;
            }
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toast.className = 'toast show ' + type;
            toastMessage.textContent = message;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Page Loaders
        async function loadPage(pageId) {
            switch (pageId) {
                case 'dashboard': await loadStatus(); break;
                case 'sites': await loadSites(); break;
                case 'services': await loadServices(); break;
                case 'dumps': await loadDumps(); break;
                case 'mail': await loadMail(); break;
                case 'logs': await loadLogs(); break;
                case 'php': await loadPHP(); break;
                case 'settings': await loadSettings(); break;
            }
        }

        async function loadStatus() {
            const data = await api('/status');
            if (data) {
                document.getElementById('stat-sites').textContent = data.sites || 0;
                document.getElementById('stat-services').textContent = data.services || 0;
                document.getElementById('stat-dumps').textContent = data.dumps || 0;
                document.getElementById('stat-php').textContent = data.php || '-';

                // Load recent sites
                const sites = await api('/sites');
                const recentSitesEl = document.getElementById('recent-sites');
                if (sites && sites.length) {
                    recentSitesEl.innerHTML = sites.slice(0, 5).map(s => `
                        <div class="list-item" style="padding: 12px 16px;">
                            <div class="item-info">
                                <div class="item-primary" style="display: flex; align-items: center; gap: 8px;">
                                    ${s.name}.test
                                    ${s.php ? `<span class="site-badge php" style="font-size: 9px; padding: 2px 6px;">PHP ${s.php}</span>` : ''}
                                </div>
                                <div class="item-secondary" style="font-size: 12px;">${s.path}</div>
                            </div>
                            <button class="icon-btn" onclick="openSiteInBrowser('${s.name}')" title="Open in browser">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                            </button>
                        </div>
                    `).join('');
                } else {
                    recentSitesEl.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No sites configured</div>';
                }

                // Load quick services
                const servicesData = await api('/services');
                const quickServicesEl = document.getElementById('quick-services');
                if (servicesData && ((servicesData.installed && servicesData.installed.length) || (servicesData.available && servicesData.available.length))) {
                    const installedServices = servicesData.installed || [];
                    if (installedServices.length) {
                        quickServicesEl.innerHTML = installedServices.slice(0, 5).map(s => `
                            <div class="list-item" style="padding: 10px 0; border-bottom: none;">
                                <div class="item-info">
                                    <div class="item-primary" style="font-size: 13px;">${s.type.toUpperCase()} ${s.version}</div>
                                </div>
                                <span class="status-badge status-${s.status}" style="padding: 4px 8px; font-size: 11px;">
                                    <span class="status-dot"></span>${s.status}
                                </span>
                                <button class="icon-btn" onclick="${s.status === 'running' ? `stopService('${s.name}')` : `startService('${s.name}')`}" style="width: 28px; height: 28px;" title="${s.status === 'running' ? 'Stop' : 'Start'}">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        ${s.status === 'running'
                                ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'
                                : '<polygon points="5 3 19 12 5 21 5 3"/>'}
                                    </svg>
                                </button>
                            </div>
                        `).join('');
                    } else {
                        quickServicesEl.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No services installed yet. Go to Services to install.</div>';
                    }
                } else {
                    quickServicesEl.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No services available</div>';
                }
            }
        }

        async function loadSites() {
            const list = document.getElementById('sites-list');
            const sites = await api('/sites');
            if (!sites || !sites.length) {
                list.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/></svg><p>No sites configured</p><p style="font-size:12px;margin-top:8px;">Add a site to get started</p></div>';
                return;
            }
            list.innerHTML = sites.map(s => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-primary">${s.name}.test</div>
                        <div class="item-secondary">${s.path}</div>
                    </div>
                    <span class="status-badge status-running"><span class="status-dot"></span>Running</span>
                </div>
            `).join('');
        }

        async function loadServices() {
            const list = document.getElementById('services-list');
            const data = await api('/services');

            if (!data) {
                list.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><p>Error loading services</p></div>';
                return;
            }

            const { installed, available } = data;

            let html = '';

            // Installed services
            if (installed && installed.length > 0) {
                html += '<h3 style="margin: 20px 24px 10px;">Installed Services</h3>';
                html += installed.map(s => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-primary">${s.name || s.type + '-' + s.version}</div>
                            <div class="item-secondary">${s.type} ${s.version}  Port ${s.port}</div>
                        </div>
                        <span class="status-badge status-${s.status}">
                            <span class="status-dot"></span>${s.status}
                        </span>
                        <div style="display:flex;gap:8px;">
                            <button class="btn" onclick="${s.status === 'running' ? `stopService('${s.name || (s.type + '-' + s.version)}')` : `startService('${s.name || (s.type + '-' + s.version)}')`}">
                                ${s.status === 'running' ? 'Stop' : 'Start'}
                            </button>
                            <button class="btn btn-danger" onclick="uninstallService('${s.name || (s.type + '-' + s.version)}')">
                                Uninstall
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Available versions
            if (available && available.length > 0) {
                const byType = available.reduce((acc, v) => {
                    if (!acc[v.type]) acc[v.type] = [];
                    acc[v.type].push(v);
                    return acc;
                }, {});

                html += '<h3 style="margin: 20px 24px 10px;">Install Service</h3>';

                Object.keys(byType).sort().forEach(type => {
                    html += `
                        <div style="margin: 0 24px 16px;">
                            <div style="font-weight:600;margin-bottom:8px;">${type.toUpperCase()}</div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                ${byType[type].map(v => `
                                    <button class="btn" onclick="installService('${v.type}', '${v.version}')">
                                        Install ${v.version}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }

            if (!installed || installed.length === 0) {
                if (!available || available.length === 0) {
                    html = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><p>No services available</p></div>';
                }
            }

            list.innerHTML = html;
        }

        async function loadDumps() {
            const list = document.getElementById('dumps-list');
            const data = await api('/dumps');
            if (!data || !data.dumps || !data.dumps.length) {
                list.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>No dumps recorded</p></div>';
                return;
            }
            list.innerHTML = data.dumps.map(d => `
                <div class="list-item" onclick="viewDump('${d.id}')" style="cursor: pointer;">
                    <div class="item-info">
                        <div class="item-primary">
                            <span class="status-badge" style="background: var(--accent-bg); color: var(--accent); padding: 2px 8px; font-size: 10px; margin-right: 8px;">${d.type}</span>
                            ${d.file}:${d.line}
                        </div>
                        <div class="item-secondary">${d.site || 'Unknown'}</div>
                    </div>
                    <span class="item-secondary">${new Date(d.timestamp).toLocaleString()}</span>
                </div>
            `).join('');
        }

        async function viewDump(id) {
            const data = await api('/dumps');
            if (data && data.dumps) {
                const dump = data.dumps.find(d => d.id === id);
                if (dump) {
                    const content = `
                        <div style="padding: 16px;">
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Type</div>
                                <div style="font-weight: 600;">${dump.type}</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Location</div>
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 12px;">${dump.file}:${dump.line}</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Timestamp</div>
                                <div>${new Date(dump.timestamp).toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Data</div>
                                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 11px; max-height: 300px; overflow-y: auto; white-space: pre-wrap;">${JSON.stringify(dump.data, null, 2)}</div>
                            </div>
                        </div>
                    `;
                    openDrawPanel('Dump Details', content, null, 'Close');
                }
            }
        }

        async function loadMail() {
            const list = document.getElementById('mail-list');
            const emails = await api('/mail');
            if (!emails || !emails.length) {
                list.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><p>No emails received</p></div>';
                return;
            }
            list.innerHTML = emails.map(e => `
                <div class="list-item" onclick="viewEmail('${e.id}')" style="cursor: pointer;">
                    <div class="item-info">
                        <div class="item-primary">${e.subject}</div>
                        <div class="item-secondary">${e.from}</div>
                    </div>
                    <span class="item-secondary">${new Date(e.timestamp).toLocaleString()}</span>
                </div>
            `).join('');
        }

        async function viewEmail(id) {
            const emails = await api('/mail');
            if (emails && emails.length) {
                const email = emails.find(e => e.id === id);
                if (email) {
                    const content = `
                        <div style="padding: 16px;">
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">From</div>
                                <div style="font-weight: 600;">${email.from}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${email.to.join(', ')}</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Subject</div>
                                <div style="font-weight: 600;">${email.subject}</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Timestamp</div>
                                <div>${new Date(email.timestamp).toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Body</div>
                                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 13px;">${email.body || '(No body)'}</div>
                            </div>
                        </div>
                    `;
                    openDrawPanel('Email Details', content, null, 'Close');
                }
            }
        }

        async function loadLogs() {
            const list = document.getElementById('logs-list');
            const logs = await api('/logs');
            if (!logs || !logs.length) {
                list.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><p>No log files found</p></div>';
                return;
            }
            list.innerHTML = logs.map(l => `
                <div class="list-item" onclick="viewLog('${l.path || l.name}')" style="cursor: pointer;">
                    <div class="item-info">
                        <div class="item-primary">${l.name}</div>
                        <div class="item-secondary">${l.site || 'System'}</div>
                    </div>
                    <span class="item-secondary">${new Date(l.modified || Date.now()).toLocaleString()}</span>
                </div>
            `).join('');
        }

        async function viewLog(path) {
            const content = `
                <div style="padding: 16px;">
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Log File</div>
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 12px; word-break: break-all;">${path}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Content</div>
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; max-height: 500px; overflow-y: auto; white-space: pre; font-family: 'JetBrains Mono', monospace; font-size: 11px;">Loading log content...</div>
                    </div>
                </div>
            `;
            openDrawPanel('Log File', content, null, 'Close');

            // Load log content (simulated - in real app this would fetch from API)
            setTimeout(() => {
                const logContentEl = document.querySelector('#drawPanelBody > div > div:last-child > div:last-child');
                if (logContentEl) {
                    logContentEl.innerHTML = 'Log content preview...<br><br><span style="color: var(--text-muted);">(Full log viewing requires server-side implementation)</span>';
                }
            }, 500);
        }

        async function loadPHP() {
            const list = document.getElementById('php-list');
            const data = await api('/php');
            if (!data || !data.versions || !data.versions.length) {
                list.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="10" ry="6"/></svg><p>No PHP versions detected</p><p style="font-size:12px;margin-top:8px;">Click <strong>Install PHP</strong> to download a standalone PHP version</p></div>';
                return;
            }
            list.innerHTML = data.versions.map(v => `
                <div class="list-item">
                    <div class="item-info" style="flex:1; min-width:0;">
                        <div class="item-primary">PHP ${v.version}</div>
                        <div class="item-secondary" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${v.path || 'System PHP'}</div>
                    </div>
                    <div class="item-actions" style="display:flex; gap:8px; flex-shrink:0;">
                        ${v.default
                    ? '<span class="status-badge status-running" style="padding:4px 10px; font-size:11px;"><span class="status-dot"></span>Default</span>'
                    : '<button class="btn" onclick="setPHPVersion(\'' + v.version + '\')" style="padding:6px 12px; font-size:12px;">Set Default</button>'
                }
                        ${v.path ? '<button class="btn btn-danger" onclick="deletePHP(\'' + v.version + '\')" style="padding:6px 12px; font-size:12px;" title="Remove from list"></button>' : ''}
                    </div>
                </div>
            `).join('');
        }

        async function deletePHP(version) {
            if (confirm('Remove PHP ' + version + ' from the list?')) {
                showToast('PHP ' + version + ' removed from list');
                loadPHP();
            }
        }

        async function loadSettings() {
            const prefs = await api('/preferences');
            if (prefs) {
                document.documentElement.setAttribute('data-theme', prefs.theme);
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === prefs.theme);
                });
                document.getElementById('auto-start-toggle').classList.toggle('active', prefs.autoStart);
                document.getElementById('tray-toggle').classList.toggle('active', prefs.showTray);
                document.getElementById('port-input').value = prefs.port || 8080;
                if (document.getElementById('slim-mode-toggle')) {
                    document.getElementById('slim-mode-toggle').classList.toggle('active', prefs.slimMode);
                    setSlimMode(prefs.slimMode);
                }
            }
        }

        // Theme
        async function setTheme(theme) {
            await api('/preferences', 'PUT', { theme });
            document.documentElement.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
            showToast('Theme changed to ' + theme);
        }

        // Settings Actions
        async function toggleAutoStart() {
            const toggle = document.getElementById('auto-start-toggle');
            const newState = !toggle.classList.contains('active');
            await api('/preferences', 'PUT', { autoStart: newState });
            toggle.classList.toggle('active', newState);
            showToast(newState ? 'Auto-start enabled' : 'Auto-start disabled');
        }

        async function toggleTray() {
            const toggle = document.getElementById('tray-toggle');
            const newState = !toggle.classList.contains('active');
            await api('/preferences', 'PUT', { showTray: newState });
            toggle.classList.toggle('active', newState);
            showToast(newState ? 'Tray icon enabled' : 'Tray icon disabled');
        }

        async function toggleSlimMode() {
            const toggle = document.getElementById('slim-mode-toggle');
            const newState = !toggle.classList.contains('active');
            await api('/preferences', 'PUT', { slimMode: newState });
            toggle.classList.toggle('active', newState);
            setSlimMode(newState);
            showToast(newState ? 'Slim mode enabled' : 'Slim mode disabled');
        }

        function setSlimMode(enabled) {
            if (enabled) {
                document.body.setAttribute('data-slim', 'true');
                localStorage.setItem('stacker_slimMode', 'true');
            } else {
                document.body.removeAttribute('data-slim');
                localStorage.setItem('stacker_slimMode', 'false');
            }
        }

        // Load slim mode on startup
        (function () {
            const slimMode = localStorage.getItem('stacker_slimMode') === 'true';
            if (slimMode) {
                document.body.setAttribute('data-slim', 'true');
            }
        })();

        async function savePort() {
            const port = parseInt(document.getElementById('port-input').value);
            if (port < 1024 || port > 65535) {
                showToast('Port must be between 1024 and 65535', 'error');
                return;
            }
            await api('/preferences', 'PUT', { port });
            showToast('Port saved! Restart to apply.');
        }

        async function checkUpdates() {
            try {
                showToast('Checking for updates...');
                const res = await fetch('https://raw.githubusercontent.com/yasinkuyu/Stacker/main/update.json');
                if (!res.ok) throw new Error('Failed to fetch');
                const data = await res.json();
                const currentVersion = '1.0.0'; // This should match app version
                const remoteVersion = data.stacker.version;
                if (remoteVersion !== currentVersion) {
                    showToast(`New version ${remoteVersion} available!`, 'info');
                    if (confirm(`New version ${remoteVersion} is available!\n\n${data.stacker.changelog}\n\nWould you like to download it?`)) {
                        window.open(data.stacker.downloadUrl, '_blank');
                    }
                } else {
                    showToast('You are running the latest version');
                }
            } catch (err) {
                showToast('Could not check for updates', 'error');
            }
        }

        // Actions
        async function clearDumps() {
            if (confirm('Clear all dumps?')) {
                await api('/dumps', 'DELETE');
                loadDumps();
                showToast('Dumps cleared');
            }
        }

        async function clearMail() {
            if (confirm('Clear all emails?')) {
                await api('/mail', 'DELETE');
                loadMail();
                showToast('Emails cleared');
            }
        }

        async function openTerminal() {
            await api('/open-terminal', 'POST', { path: "" });
        }

        async function setPHPVersion(version) {
            await api('/php/default', 'PUT', { version });
            showToast('PHP version set to ' + version);
            loadPHP();
        }

        // ==========================================
        // Draw Panel Functions
        // ==========================================

        let currentPanel = null;
        let currentSite = null;

        function openDrawPanel(title, content, onSave, saveText = 'Save') {
            document.getElementById('drawPanelTitle').textContent = title;
            document.getElementById('drawPanelBody').innerHTML = content;
            document.getElementById('drawPanelOverlay').classList.add('open');
            document.getElementById('drawPanel').classList.add('open');

            const saveBtn = document.getElementById('drawPanelSave');
            saveBtn.textContent = saveText;
            saveBtn.onclick = onSave;
            document.getElementById('drawPanelFooter').style.display = 'flex';
            currentPanel = { title, onSave };
        }

        function closeDrawPanel() {
            document.getElementById('drawPanelOverlay').classList.remove('open');
            document.getElementById('drawPanel').classList.remove('open');
            currentPanel = null;
            currentSite = null;
        }

        // ==========================================
        // Site Management
        // ==========================================

        async function addSite() {
            const data = await api('/php');
            const phpVersions = data && data.versions ? data.versions : [];
            const phpOptions = phpVersions.map(v =>
                `<option value="${v.version}">PHP ${v.version}${v.default ? ' (Default)' : ''}</option>`
            ).join('');

            const content = `
                <div class="form-group">
                    <label class="form-label">Site Name</label>
                    <input type="text" class="form-input" id="siteName" placeholder="my-project">
                    <div class="form-hint">Will be accessible at my-project.test</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Project Path</label>
                    <div style="display:flex;gap:8px;">
                        <input type="text" class="form-input" id="sitePath" placeholder="/Users/you/Sites/my-project" style="flex:1;">
                        <button class="btn" onclick="browsePath()">Browse</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">PHP Version</label>
                    <select class="form-select" id="sitePhp">
                        <option value="">Use Default</option>
                        ${phpOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div class="settings-row" style="padding:12px 0;border:none;">
                        <div class="settings-info">
                            <div class="settings-label">Enable SSL</div>
                            <div class="settings-desc">Serve site over HTTPS</div>
                        </div>
                        <button class="toggle-switch active" id="siteSsl" onclick="this.classList.toggle('active')"></button>
                    </div>
                </div>
            `;

            openDrawPanel('Add New Site', content, saveSite);
        }

        async function editSite(site) {
            currentSite = site;
            const data = await api('/php');
            const phpVersions = data && data.versions ? data.versions : [];
            const phpOptions = phpVersions.map(v =>
                `<option value="${v.version}" ${site.php === v.version ? 'selected' : ''}>PHP ${v.version}${v.default ? ' (Default)' : ''}</option>`
            ).join('');

            const content = `
                <div class="form-group">
                    <label class="form-label">Site Name</label>
                    <input type="text" class="form-input" id="siteName" value="${site.name}">
                </div>
                <div class="form-group">
                    <label class="form-label">Project Path</label>
                    <input type="text" class="form-input" id="sitePath" value="${site.path}">
                </div>
                <div class="form-group">
                    <label class="form-label">PHP Version</label>
                    <select class="form-select" id="sitePhp">
                        <option value="">Use Default</option>
                        ${phpOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div class="settings-row" style="padding:12px 0;border:none;">
                        <div class="settings-info">
                            <div class="settings-label">Enable SSL</div>
                        </div>
                        <button class="toggle-switch ${site.ssl ? 'active' : ''}" id="siteSsl" onclick="this.classList.toggle('active')"></button>
                    </div>
                </div>
                <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
                    <button class="btn btn-danger" onclick="deleteSite('${site.name}')">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Delete Site
                    </button>
                </div>
            `;

            openDrawPanel('Edit Site: ' + site.name, content, updateSite);
        }

        async function saveSite() {
            const name = document.getElementById('siteName').value.trim();
            const path = document.getElementById('sitePath').value.trim();
            const php = document.getElementById('sitePhp').value;
            const ssl = document.getElementById('siteSsl').classList.contains('active');

            if (!name || !path) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            await api('/sites', 'POST', { name, path, php, ssl });
            closeDrawPanel();
            showToast('Site added successfully');
            loadSites();
        }

        async function updateSite() {
            const name = document.getElementById('siteName').value.trim();
            const path = document.getElementById('sitePath').value.trim();
            const php = document.getElementById('sitePhp').value;
            const ssl = document.getElementById('siteSsl').classList.contains('active');

            await api('/sites/' + currentSite.name, 'PUT', { name, path, php, ssl });
            closeDrawPanel();
            showToast('Site updated successfully');
            loadSites();
        }

        async function deleteSite(name) {
            if (confirm('Are you sure you want to delete this site?')) {
                await api('/sites/' + name, 'DELETE');
                closeDrawPanel();
                showToast('Site deleted');
                loadSites();
            }
        }

        function openSiteInBrowser(name) {
            window.open('https://' + name + '.test', '_blank');
        }

        async function openSiteFolder(path) {
            await api('/open-folder', 'POST', { path });
        }

        async function browsePath() {
            const res = await api('/browse-folder');
            if (res && res.path) {
                document.getElementById('sitePath').value = res.path;
                // If it's a new site and name is empty, try to guess name from path
                const nameInput = document.getElementById('siteName');
                if (nameInput && !nameInput.value) {
                    nameInput.value = res.path.split('/').pop().toLowerCase().replace(/[^a-z0-9]/g, '-');
                }
            }
        }

        async function openTerminal(path = "") {
            // If path is empty string (Default Terminal button), use home or stacker dir
            await api('/open-terminal', 'POST', { path });
        }

        // ==========================================
        // Server Configuration
        // ==========================================

        function openServerConfig() {
            const content = `
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab(this, 'nginx-tab')">Nginx</button>
                    <button class="tab-btn" onclick="switchTab(this, 'mysql-tab')">MySQL</button>
                    <button class="tab-btn" onclick="switchTab(this, 'redis-tab')">Redis</button>
                </div>
                
                <div id="nginx-tab" class="tab-content active">
                    <div class="service-card">
                        <div class="service-info">
                            <div class="service-icon nginx">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="service-name">Nginx</div>
                                <div class="service-port">Port: 80, 443</div>
                            </div>
                        </div>
                        <div class="service-actions">
                            <span class="status-badge status-running"><span class="status-dot"></span>Running</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">HTTP Port</label>
                        <input type="number" class="form-input" id="nginxPort" value="80">
                    </div>
                    <div class="form-group">
                        <label class="form-label">HTTPS Port</label>
                        <input type="number" class="form-input" id="nginxSslPort" value="443">
                    </div>
                </div>
                
                <div id="mysql-tab" class="tab-content">
                    <div class="service-card">
                        <div class="service-info">
                            <div class="service-icon mysql">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/>
                                </svg>
                            </div>
                            <div>
                                <div class="service-name">MySQL</div>
                                <div class="service-port">Port: 3306</div>
                            </div>
                        </div>
                        <div class="service-actions">
                            <button class="toggle-switch active" id="mysqlToggle"></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-input" id="mysqlPort" value="3306">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Root Password</label>
                        <input type="password" class="form-input" id="mysqlPassword" placeholder="">
                    </div>
                </div>
                
                <div id="redis-tab" class="tab-content">
                    <div class="service-card">
                        <div class="service-info">
                            <div class="service-icon redis">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                </svg>
                            </div>
                            <div>
                                <div class="service-name">Redis</div>
                                <div class="service-port">Port: 6379</div>
                            </div>
                        </div>
                        <div class="service-actions">
                            <button class="toggle-switch" id="redisToggle"></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-input" id="redisPort" value="6379">
                    </div>
                </div>
            `;

            openDrawPanel('Server Configuration', content, saveServerConfig);
        }

        function switchTab(btn, tabId) {
            btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        async function saveServerConfig() {
            showToast('Server configuration saved');
            closeDrawPanel();
        }

        // ==========================================
        // PHP Installation
        // ==========================================

        function openInstallPHP() {
            const content = `
                <div style="padding: 16px; text-align: center; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 24px; margin-bottom: 12px;"></div>
                    <div style="font-weight: 600; margin-bottom: 8px;">Install PHP (Standalone)</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Downloads pre-built static PHP binaries. No Homebrew or system dependencies required.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Select PHP Version</label>
                    <select class="form-select" id="installPhpVersion">
                        <option value="8.4">PHP 8.4 (Latest)</option>
                        <option value="8.3" selected>PHP 8.3 (Recommended)</option>
                        <option value="8.2">PHP 8.2 (LTS)</option>
                        <option value="8.1">PHP 8.1</option>
                        <option value="8.0">PHP 8.0</option>
                    </select>
                    <div class="form-hint">PHP will be downloaded from static-php.dev (no external dependencies)</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div class="settings-row" style="padding:12px 0;border:none;">
                        <div class="settings-info">
                            <div class="settings-label">Enable XDebug</div>
                            <div class="settings-desc">Include debugging support (larger download)</div>
                        </div>
                        <button class="toggle-switch" id="installXdebug" onclick="this.classList.toggle('active')"></button>
                    </div>
                </div>

                <div style="padding: 12px; background: var(--success-bg); border-radius: 8px; margin-top: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--success);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 6L9 17l-5-5"/>
                        </svg>
                        <span style="font-weight: 600;">100% Standalone</span>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">No Homebrew, apt, or any package manager needed</div>
                </div>
            `;

            openDrawPanel('Install PHP', content, installPHP, 'Install');
        }

        function copyCommand(command) {
            navigator.clipboard.writeText(command);
            showToast('Command copied to clipboard');
        }

        async function installPHP() {
            const version = document.getElementById('installPhpVersion').value;
            const xdebug = document.getElementById('installXdebug').classList.contains('active');

            // Hide footer during install
            document.getElementById('drawPanelFooter').style.display = 'none';

            // Show progress in panel body
            const body = document.getElementById('drawPanelBody');
            body.innerHTML = `
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Installing PHP ${version}</span>
                        <span id="installPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="installProgressFill"></div>
                    </div>
                    <div class="install-log" id="installLog">
                        Starting download...<br>
                    </div>
                </div>
            `;

            // Start installation
            api('/php/install', 'POST', { version, xdebug });

            // Poll progress
            const log = document.getElementById('installLog');
            const fill = document.getElementById('installProgressFill');
            const perc = document.getElementById('installPercent');

            let progress = 0;
            const interval = setInterval(async () => {
                const status = await api(`/php/install-status?version=${version}`);
                if (status && status.progress !== undefined) {
                    progress = status.progress;

                    // Check for error
                    if (progress === -1) {
                        clearInterval(interval);
                        log.innerHTML += `<span style="color:#ef4444;"> Error: Failed to download PHP ${version}<br>`;
                        log.innerHTML += `<span style="color:#fbbf24;"> Please try a different version or check your internet connection</span><br>`;
                        perc.textContent = 'Error';
                        fill.style.width = '100%';
                        fill.style.background = '#ef4444';
                        return;
                    }

                    fill.style.width = progress + '%';
                    perc.textContent = progress + '%';

                    if (progress > 0 && progress < 100) {
                        log.innerHTML = `Downloading PHP binary... ${progress}%<br>`;
                    } else if (progress === 100) {
                        log.innerHTML += `Extracting files...<br>`;
                        log.innerHTML += `Finalizing installation...<br>`;
                        clearInterval(interval);

                        setTimeout(() => {
                            showToast('PHP ' + version + ' installed successfully');
                            closeDrawPanel();
                            loadPHP();
                        }, 1000);
                    }

                    // Service Management
                    // =========================================

                    async function installService(type, version) {
                        const content = `
                <div class="form-group">
                    <label class="form-label">Installing ${type.toUpperCase()} ${version}</label>
                    <div class="form-hint">This will download and compile the service</div>
                </div>
            `;

                        openDrawPanel('Install Service', content, () => {
                            startServiceInstall(type, version);
                        }, 'Install');
                    }

                    async function startServiceInstall(type, version) {
                        // Hide footer during install
                        document.getElementById('drawPanelFooter').style.display = 'none';

                        // Show progress in panel body
                        const body = document.getElementById('drawPanelBody');
                        body.innerHTML = `
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Installing ${type.toUpperCase()} ${version}</span>
                        <span id="installPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="installProgressFill"></div>
                    </div>
                    <div class="install-log" id="installLog">
                        Starting download...<br>
                    </div>
                </div>
            `;

                        // Start installation
                        try {
                            await api('/services/install', 'POST', { type, version });

                            const log = document.getElementById('installLog');
                            const fill = document.getElementById('installProgressFill');
                            const perc = document.getElementById('installPercent');

                            // Poll progress
                            const interval = setInterval(async () => {
                                const status = await api(`/services/install-status?type=${type}&version=${version}`);
                                if (status && status.progress !== undefined) {
                                    const progress = status.progress;

                                    // Check for error
                                    if (progress === -1) {
                                        clearInterval(interval);
                                        log.innerHTML += `<span style="color:#ef4444;"> Error: Installation failed<br>`;
                                        log.innerHTML += `<span style="color:#fbbf24;"> Compilation failed. This usually means missing build tools.<br>`;
                                        log.innerHTML += `<span style="color:#fbbf24;"> Install Xcode Command Line Tools: xcode-select --install</span><br>`;
                                        perc.textContent = 'Error';
                                        fill.style.width = '100%';
                                        fill.style.background = '#ef4444';
                                        return;
                                    }

                                    fill.style.width = progress + '%';
                                    perc.textContent = progress + '%';

                                    if (progress >= 0 && progress < 10) {
                                        log.innerHTML = `Starting installation...<br>`;
                                    } else if (progress >= 10 && progress < 30) {
                                        log.innerHTML = `Downloading source code...<br>`;
                                    } else if (progress >= 30 && progress < 75) {
                                        log.innerHTML = `Compiling ${type.toUpperCase()}...<br>`;
                                        log.innerHTML += `<span style="color:#fbbf24;"> This may take several minutes...<br>`;
                                    } else if (progress >= 75 && progress < 95) {
                                        log.innerHTML = `Installing binaries...<br>`;
                                    } else if (progress >= 95 && progress < 100) {
                                        log.innerHTML = `Configuring service...<br>`;
                                    } else if (progress === 100) {
                                        clearInterval(interval);
                                        log.innerHTML = ` Installation complete!<br>`;
                                        fill.style.width = '100%';
                                        perc.textContent = '100%';

                                        setTimeout(() => {
                                            showToast(`${type.toUpperCase()} ${version} installed successfully`);
                                            closeDrawPanel();
                                            loadServices();
                                        }, 1000);
                                    }
                                }
                            }, 1000);
                        } catch (error) {
                            const log = document.getElementById('installLog');
                            log.innerHTML += `<span style="color:#ef4444;">Error: ${error.message}<br>`;
                        }
                    }

                    async function startService(name) {
                        try {
                            const result = await api(`/services/start/${name}`, 'POST');
                            showToast(`Service ${name} started`);
                            loadServices();
                        } catch (error) {
                            showToast(`Error starting service: ${error.message}`);
                        }
                    }

                    async function stopService(name) {
                        try {
                            const result = await api(`/services/stop/${name}`, 'POST');
                            showToast(`Service ${name} stopped`);
                            loadServices();
                        } catch (error) {
                            showToast(`Error stopping service: ${error.message}`);
                        }
                    }

                    async function uninstallService(name) {
                        if (!confirm(`Are you sure you want to uninstall ${name}?`)) {
                            return;
                        }

                        try {
                            await api('/services/uninstall', 'POST', { name });
                            showToast(`Service ${name} uninstalled`);
                            loadServices();
                        } catch (error) {
                            showToast(`Error uninstalling service: ${error.message}`);
                        }
                    }
                }
            }, 1000);
        }

        // ==========================================
        // Service Installation
        // ==========================================

        function openInstallService(serviceName) {
            const services = {
                mysql: { name: 'MySQL', port: 3306, icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>' },
                nginx: { name: 'Nginx', port: 80, icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>' },
                redis: { name: 'Redis', port: 6379, icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>' },
                meilisearch: { name: 'Meilisearch', port: 7700, icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>' }
            };

            const svc = services[serviceName];
            if (!svc) return;

            const content = `
                <div class="service-card" style="margin-bottom:24px;">
                    <div class="service-info">
                        <div class="service-icon ${serviceName}">${svc.icon}</div>
                        <div>
                            <div class="service-name">${svc.name}</div>
                            <div class="service-port">Default Port: ${svc.port}</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Port</label>
                    <input type="number" class="form-input" id="servicePort" value="${svc.port}">
                </div>
                
                ${serviceName === 'mysql' ? `
                <div class="form-group">
                    <label class="form-label">Root Password</label>
                    <input type="password" class="form-input" id="mysqlRootPass" placeholder="Enter password">
                </div>
                ` : ''}
                
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div class="settings-row" style="padding:12px 0;border:none;">
                        <div class="settings-info">
                            <div class="settings-label">Start on boot</div>
                        </div>
                        <button class="toggle-switch active" id="serviceAutoStart" onclick="this.classList.toggle('active')"></button>
                    </div>
                </div>
            `;

            openDrawPanel('Install ' + svc.name, content, () => installServiceLegacy(serviceName));
        }

        async function installServiceLegacy(serviceName) {
            const port = document.getElementById('servicePort').value;
            showToast('Installing ' + serviceName + '...');
            closeDrawPanel();

            await api('/services/install', 'POST', { name: serviceName, port: parseInt(port) });
            showToast(serviceName + ' installed successfully');
            loadServices();
        }

        // Update loadSites to use new format
        async function loadSites() {
            const list = document.getElementById('sites-list');
            const sites = await api('/sites');
            if (!sites || !sites.length) {
                list.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/></svg><p>No sites configured</p><p style="font-size:12px;margin-top:8px;">Click "Add Site" to get started</p></div>';
                return;
            }
            list.innerHTML = sites.map(s => `
                <div class="site-row">
                    <div class="site-info" onclick="editSite(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                        <div class="site-name">
                            ${s.name}.test
                        </div>
                        <div class="site-path">${s.path}</div>
                    </div>
                    <div class="site-badges">
                        ${s.php ? '<span class="site-badge php">PHP ' + s.php + '</span>' : ''}
                        ${s.ssl ? '<span class="site-badge ssl">SSL</span>' : ''}
                    </div>
                    <div class="site-actions">
                        <button class="icon-btn" onclick="openSiteInBrowser('${s.name}')" title="Open in browser">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="openSiteFolder('${s.path}')" title="Open folder">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                        <button class="icon-btn danger" onclick="deleteSite('${s.name}')" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update loadServices with real API data
        async function loadServices() {
            const list = document.getElementById('services-list');
            const data = await api('/services');

            if (!data) return;

            const installed = data.installed || [];
            const available = data.available || [];

            // Group available services by type
            const availableByType = {};
            available.forEach(v => {
                if (!availableByType[v.type]) {
                    availableByType[v.type] = [];
                }
                availableByType[v.type].push(v.version);
            });

            // Service icons and names
            const serviceInfo = {
                nginx: {
                    name: 'Nginx',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
                    port: '80, 443',
                    colorClass: 'nginx'
                },
                apache: {
                    name: 'Apache',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
                    port: '8080',
                    colorClass: 'apache'
                },
                mysql: {
                    name: 'MySQL',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>',
                    port: '3306',
                    colorClass: 'mysql'
                },
                mariadb: {
                    name: 'MariaDB',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>',
                    port: '3306',
                    colorClass: 'mariadb'
                },
                redis: {
                    name: 'Redis',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
                    port: '6379',
                    colorClass: 'redis'
                }
            };

            // Get all service types
            const allTypes = ['nginx', 'apache', 'mysql', 'mariadb', 'redis'];

            let html = '';
            allTypes.forEach(type => {
                const info = serviceInfo[type];
                if (!info) return;

                const installedService = installed.find(s => s.type === type);
                const availableVersions = availableByType[type] || [];

                let actions = '';
                if (installedService) {
                    if (installedService.status === 'running') {
                        actions = `
                            <button class="btn" onclick="stopService('${installedService.name}')" style="padding: 6px 12px; font-size: 12px;">Stop</button>
                        `;
                    } else {
                        actions = `
                            <button class="btn btn-success" onclick="startService('${installedService.name}')" style="padding: 6px 12px; font-size: 12px;">Start</button>
                            <button class="btn btn-danger" onclick="uninstallService('${installedService.name}')" style="padding: 6px 12px; font-size: 12px;">Uninstall</button>
                        `;
                    }
                } else if (availableVersions.length > 0) {
                    actions = `
                        <button class="btn btn-primary" onclick="openInstallService('${type}', '${availableVersions[0]}')" style="padding: 6px 12px; font-size: 12px;">Install</button>
                    `;
                } else {
                    actions = '<span style="color: var(--text-muted); font-size: 12px;">Not available</span>';
                }

                const status = installedService
                    ? (installedService.status === 'running' ? 'running' : 'stopped')
                    : 'none';

                html += `
                    <div class="service-card" style="margin: 0 24px 12px;">
                        <div class="service-info">
                            <div class="service-icon ${info.colorClass}">
                                ${info.icon}
                            </div>
                            <div>
                                <div class="service-name">${info.name}</div>
                                <div class="service-port">:${info.port}</div>
                            </div>
                        </div>
                        ${installedService ? `<span class="status-badge status-${status}"><span class="status-dot"></span>${status}</span>` : ''}
                        <div class="service-actions">
                            ${actions}
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        async function openInstallService(type, version) {
            const content = `
                <div class="form-group">
                    <label class="form-label">Installing ${type.toUpperCase()} ${version}</label>
                    <div class="form-hint">This will download and compile the service</div>
                </div>
            `;

            openDrawPanel('Install Service', content, () => {
                startServiceInstallGlobal(type, version);
            }, 'Install');
        }

        async function startServiceInstallGlobal(type, version) {
            // Hide footer during install
            document.getElementById('drawPanelFooter').style.display = 'none';

            // Show progress in panel body
            const body = document.getElementById('drawPanelBody');
            body.innerHTML = `
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Installing ${type.toUpperCase()} ${version}</span>
                        <span id="installPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="installProgressFill"></div>
                    </div>
                    <div class="install-log" id="installLog">
                        Starting download...<br>
                    </div>
                </div>
            `;

            // Start installation
            try {
                await api('/services/install', 'POST', { type, version });

                const log = document.getElementById('installLog');
                const fill = document.getElementById('installProgressFill');
                const perc = document.getElementById('installPercent');

                // Poll progress
                const interval = setInterval(async () => {
                    const status = await api(`/services/install-status?type=${type}&version=${version}`);
                    if (status && status.progress !== undefined) {
                        const progress = status.progress;

                        // Check for error
                        if (progress === -1) {
                            clearInterval(interval);
                            log.innerHTML += `<span style="color:#ef4444;"> Error: Installation failed<br>`;
                            log.innerHTML += `<span style="color:#fbbf24;"> Install Xcode Command Line Tools: xcode-select --install</span><br>`;
                            perc.textContent = 'Error';
                            fill.style.width = '100%';
                            fill.style.background = '#ef4444';
                            return;
                        }

                        fill.style.width = progress + '%';
                        perc.textContent = progress + '%';

                        if (progress >= 0 && progress < 10) {
                            log.innerHTML = `Starting installation...<br>`;
                        } else if (progress >= 10 && progress < 30) {
                            log.innerHTML = `Downloading source code...<br>`;
                        } else if (progress >= 30 && progress < 75) {
                            log.innerHTML = `Compiling ${type.toUpperCase()}...<br>`;
                            log.innerHTML += `<span style="color:#fbbf24;"> This may take several minutes...</span><br>`;
                        } else if (progress >= 75 && progress < 95) {
                            log.innerHTML = `Installing binaries...<br>`;
                        } else if (progress >= 95 && progress < 100) {
                            log.innerHTML = `Configuring service...<br>`;
                        } else if (progress === 100) {
                            clearInterval(interval);
                            log.innerHTML = ` Installation complete!<br>`;
                            fill.style.width = '100%';
                            perc.textContent = '100%';

                            setTimeout(() => {
                                closeDrawPanel();
                                loadServices();
                                showToast(type.toUpperCase() + ' installed successfully');
                            }, 1500);
                        }
                    }
                }, 1000);

            } catch (err) {
                const log = document.getElementById('installLog');
                log.innerHTML += `<span style="color:#ef4444;"> Error: ${err.message}<br>`;
            }
        }

        // Initial Load
        loadStatus();
        loadSettings();
        setInterval(loadStatus, 5000);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDrawPanel();
        });
    </script>
</body>

</html>