<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stacker - Development Environment</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <style>
        :root {
            /* Light theme - improved contrast */
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8ec;
            --bg-hover: #d4d4d9;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #7a7a7a;
            --accent: #6366f1;
            --accent-hover: #5558d6;
            --accent-light: rgba(99, 102, 241, 0.15);
            --success: #059669;
            --success-bg: rgba(5, 150, 105, 0.15);
            --warning: #d97706;
            --warning-bg: rgba(217, 119, 6, 0.15);
            --danger: #dc2626;
            --danger-bg: rgba(220, 38, 38, 0.15);
            --border: #e0e0e5;
            --border-light: #efefef;
            --shadow: rgba(0, 0, 0, 0.03);
            --shadow-lg: rgba(0, 0, 0, 0.06);
            --gradient-start: #6366f1;
            --gradient-end: #8b5cf6;
            /* New 3-column layout */
            --icon-nav-width: 64px;
            --sites-panel-width: 260px;
            --sidebar-width: calc(var(--icon-nav-width) + var(--sites-panel-width));
            --statusbar-height: 40px;
        }

        [data-theme="dark"] {
            /* Dark theme - improved contrast */
            --bg-primary: #0a0a0f;
            --bg-secondary: #14141a;
            --bg-tertiary: #1e1e28;
            --bg-hover: #282835;
            --text-primary: #f0f0f5;
            --text-secondary: #b8b8c5;
            --text-muted: #6b6b7a;
            --accent: #818cf8;
            --accent-hover: #a5b4fc;
            --accent-light: rgba(129, 140, 248, 0.15);
            --success: #34d399;
            --success-bg: rgba(52, 211, 153, 0.15);
            --warning: #fbbf24;
            --warning-bg: rgba(251, 191, 36, 0.15);
            --danger: #f87171;
            --danger-bg: rgba(248, 113, 113, 0.15);
            --border: #252535;
            --border-light: #353545;
            --shadow: rgba(0, 0, 0, 0.15);
            --shadow-lg: rgba(0, 0, 0, 0.25);
            --gradient-start: #818cf8;
            --gradient-end: #a78bfa;
        }

        body[data-slim="true"] {
            --sidebar-width: 200px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
            line-height: 1.5;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Loading Spinner */
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ==========================================
           3-COLUMN LAYOUT: Icon Nav + Sites Panel + Content
           ========================================== */

        /* Icon Navigation (leftmost, always visible) */
        .icon-nav {
            width: var(--icon-nav-width);
            background: linear-gradient(180deg, var(--gradient-start), var(--gradient-end));
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1100;
            gap: 8px;
        }

        .icon-nav-logo {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            margin-bottom: 24px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
        }

        .icon-nav-logo img {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }

        .icon-nav-title {
            display: none;
            font-size: 16px;
            font-weight: 700;
            color: white;
            white-space: nowrap;
            margin-left: 12px;
        }

        body[data-navbar-expanded="true"] .icon-nav-logo {
            width: 140px;
            justify-content: flex-start;
            padding-left: 8px;
        }

        body[data-navbar-expanded="true"] .icon-nav-title {
            display: block;
        }

        .icon-nav-item {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            position: relative;
        }

        .icon-nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        /* Hover tooltip showing label on the right */
        .icon-nav-item:hover .icon-nav-label {
            display: block;
            position: absolute;
            left: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 2px 8px var(--shadow-lg);
            z-index: 1200;
            pointer-events: none;
        }

        .icon-nav-item.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            box-shadow: inset 3px 0 0 white;
        }

        .icon-nav-item svg {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
        }

        /* Icon Nav Labels (hidden by default, shown when expanded) */
        .icon-nav-label {
            display: none;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        body[data-navbar-expanded="true"] .icon-nav {
            width: 160px;
        }

        body[data-navbar-expanded="true"] .icon-nav-item {
            width: 140px;
            justify-content: flex-start;
            padding-left: 16px;
            gap: 12px;
        }

        body[data-navbar-expanded="true"] .icon-nav-label {
            display: block;
            position: static;
            transform: none;
            background: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            z-index: auto;
            pointer-events: auto;
        }

        body[data-navbar-expanded="true"] .icon-nav-item:hover .icon-nav-label {
            position: static;
            transform: none;
            background: transparent;
            color: inherit;
            padding: 0;
            box-shadow: none;
            left: auto;
            top: auto;
        }

        body[data-navbar-expanded="true"] .main-content {
            margin-left: calc(160px + var(--sites-panel-width));
        }

        body[data-navbar-expanded="true"] .footer-bar {
            left: 160px;
        }

        body[data-navbar-expanded="true"][data-panel-collapsed="true"] .main-content {
            margin-left: 160px;
        }

        body[data-panel-collapsed="true"] .footer-bar {
            left: var(--icon-nav-width);
        }

        body[data-navbar-expanded="true"] .sites-panel {
            left: 160px;
        }

        body[data-navbar-expanded="true"] .add-site-btn {
            left: calc(160px + 16px);
        }

        body[data-navbar-expanded="true"] .status-bar-bottom {
            padding-left: calc(160px + 20px);
        }

        .icon-nav-spacer {
            flex: 1;
        }

        .icon-nav-toggle {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: bold;
        }

        .icon-nav-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        /* Sites Panel (collapsible middle) */
        .sites-panel {
            width: var(--sites-panel-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: var(--icon-nav-width);
            height: calc(100vh - var(--statusbar-height));
            z-index: 1040;
            transition: width 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
            overflow: hidden;
        }

        .sites-panel.collapsed {
            width: 0;
            opacity: 0;
            transform: translateX(-20px);
        }

        .sites-panel-header {
            padding: 20px 16px 12px;
            border-bottom: 1px solid var(--border);
        }

        .sites-panel-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .sites-panel-search {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .sites-panel-search:focus {
            border-color: var(--accent);
        }

        .sites-panel-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        /* Panel Components */
        .panel-empty {
            padding: 24px 16px;
            text-align: center;
        }

        .panel-empty-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--accent);
            display: flex;
            justify-content: center;
        }

        .panel-empty-icon svg {
            color: var(--accent);
            opacity: 0.6;
        }

        .panel-empty-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .panel-empty-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .panel-empty-desc code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .panel-stats {
            display: flex;
            justify-content: space-around;
            padding: 16px 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .panel-stat {
            text-align: center;
        }

        .panel-stat-value {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        .panel-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .panel-info-box {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            margin: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .panel-info-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .panel-info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
        }

        .panel-tip {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            margin: 8px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .panel-tip code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .panel-quick-links {
            padding: 8px;
        }

        .panel-quick-link {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            color: var(--text-primary);
        }

        .panel-quick-link:hover {
            background: var(--bg-tertiary);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .site-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .site-list-item:hover {
            background: var(--bg-hover);
        }

        .site-list-item.active {
            background: var(--accent-light);
        }

        .site-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .site-status-dot.running {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .site-status-dot.stopped {
            background: var(--text-muted);
        }

        .site-list-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sites-panel-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }

        .add-site-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-lg);
            transition: transform 0.2s, box-shadow 0.2s;
            position: fixed;
            bottom: calc(var(--statusbar-height) + 20px);
            left: calc(var(--icon-nav-width) + 16px);
            z-index: 1050;
        }

        .add-site-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-lg);
        }

        body[data-panel-collapsed="true"] .add-site-btn {
            left: calc(var(--icon-nav-width) + 16px);
        }

        /* Legacy sidebar - now hidden */
        .sidebar {
            display: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-lg);
        }

        .logo-img {
            width: 36px;
            height: 36px;
            border-radius: 8px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        .logo-version {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-section {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 16px 16px 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            opacity: 0.8;
        }

        .nav-item.active .nav-icon {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 24px 28px 28px;
            margin-left: calc(var(--icon-nav-width) + var(--sites-panel-width));
            min-height: 100vh;
            margin-bottom: 0;
            background: var(--bg-primary);
            position: relative;
            z-index: 1;
            overflow-x: hidden;
            transition: margin-left 0.3s ease, padding 0.3s ease;
        }

        body[data-panel-collapsed="true"] .main-content {
            margin-left: var(--icon-nav-width);
        }

        body[data-panel-collapsed="true"] .sites-panel {
            width: 0;
            opacity: 0;
            pointer-events: none;
        }

        body[data-slim="true"] .main-content {
            padding-bottom: 32px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Footer Bar */
        /* Global Progress */
        .global-progress {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(0, 0, 0, 0.05);
            z-index: 2000;
            display: none;
        }

        .global-progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent);
            transition: width 0.3s ease;
        }

        [data-theme="dark"] .global-progress {
            background: rgba(255, 255, 255, 0.05);
        }

        .footer-bar {
            position: fixed;
            bottom: 0;
            left: var(--icon-nav-width);
            right: 0;
            height: 40px;
            transition: left 0.3s ease;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1050;
            font-size: 12px;
        }

        .footer-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footer-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .footer-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .footer-btn-start {
            background: var(--success-bg);
            color: var(--success);
        }

        .footer-btn-start:hover {
            background: var(--success);
            color: white;
        }

        .footer-btn-stop {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .footer-btn-stop:hover {
            background: var(--danger);
            color: white;
        }

        .footer-right {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-muted);
        }

        .footer-brand {
            font-weight: 600;
            color: var(--accent);
        }

        .footer-version {
            opacity: 0.7;
        }

        .footer-copyright {
            opacity: 0.5;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-lg);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .stat-icon.sites {
            background: var(--accent-light);
            color: var(--accent);
        }

        .stat-icon.services {
            background: var(--success-bg);
            color: var(--success);
        }

        .stat-icon.dumps {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .stat-icon.php {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 4px var(--shadow);
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 0;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s ease;
        }

        .list-item:hover {
            background: var(--bg-hover);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-primary {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .item-secondary {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-running {
            color: var(--success);
            background: var(--success-bg);
        }

        .status-stopped {
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-running .status-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-muted);
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.5;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-loading {
            cursor: not-allowed;
            opacity: 0.8;
            pointer-events: none;
        }

        .spinner-sm {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        }

        /* Adjust spinner color based on button type */
        .btn-white .spinner-sm,
        .btn:not(.btn-primary):not(.btn-danger):not(.btn-warning) .spinner-sm {
            border-color: rgba(0, 0, 0, 0.1);
            border-top-color: var(--accent);
        }

        .btn:hover {
            background: var(--accent-light);
            color: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled,
        .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(100%);
            box-shadow: none !important;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white !important;
            font-weight: 600;
        }

        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 4px 12px var(--shadow-lg);
            transform: translateY(-2px);
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)) !important;
            color: white !important;
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--danger-bg);
        }

        .btn-success {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .btn-success:hover {
            background: var(--success);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--success-bg);
        }

        .btn-icon {
            width: 16px;
            height: 16px;
        }

        .btn.btn-icon-only {
            padding: 8px;
            min-width: auto;
        }

        .btn.btn-icon-only svg {
            margin: 0;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section:first-child {
            padding-top: 24px;
        }

        .settings-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 0 24px;
            margin-bottom: 12px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-info {
            flex: 1;
        }

        .settings-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Toggle Switch */
        .toggle-switch {
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0;
            display: inline-block;
            vertical-align: middle;
        }

        .toggle-switch.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 12px;
        }

        .theme-btn {
            width: 44px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .theme-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px var(--shadow-lg);
        }

        .theme-btn:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Input */
        .input {
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding: 20px 24px;
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1600;
            animation: slideIn 0.3s ease;
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
            color: var(--text-secondary);
            z-index: 1000;
        }

        .status-bar-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .server-status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Draw Panel - Slide-in Side Panel */
        .draw-panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1450;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .draw-panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .draw-panel {
            position: fixed;
            top: 0;
            right: -480px;
            width: 480px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 1500;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
            box-shadow: -8px 0 32px var(--shadow-lg);
        }

        .draw-panel.open {
            right: 0;
        }

        .draw-panel.wide {
            width: 800px;
            right: -800px;
        }

        .draw-panel.wide.open {
            right: 0;
        }

        .draw-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .draw-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .draw-panel-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--bg-hover);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .draw-panel-close:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .draw-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .draw-panel-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Custom Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1550;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 440px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            transform: scale(0.9);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-hover);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .modal-body {
            padding: 24px;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: var(--bg-tertiary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Service Card */
        .service-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px var(--shadow);
            transition: all 0.2s;
            flex-wrap: wrap;
            gap: 12px;
        }

        @media (max-width: 600px) {
            .service-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .service-actions {
                width: 100%;
                justify-content: flex-start;
                padding-top: 8px;
                border-top: 1px solid var(--border-light);
            }
        }

        .service-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            padding: 8px;
            border: 1px solid var(--border-light);
        }

        .service-icon svg {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .service-icon.mysql {
            background: #00758f20;
            color: #00758f;
        }

        .service-icon.nginx {
            background: #00994420;
            color: #009944;
        }

        .service-icon.redis {
            background: #dc382d20;
            color: #dc382d;
        }

        .service-icon.php {
            background: #777bb420;
            color: #777bb4;
        }

        .service-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .service-port {
            font-size: 12px;
            color: var(--text-muted);
        }

        .service-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Site Row */
        .site-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s ease;
            gap: 16px;
        }

        .site-row:hover {
            background: var(--bg-hover);
        }

        .site-row:last-child {
            border-bottom: none;
        }

        .site-info {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .site-name {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .site-path {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .site-badges {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }

        .site-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .site-badge.php {
            background: rgba(119, 123, 180, 0.12);
            color: #777bb4;
            border: 1px solid rgba(119, 123, 180, 0.2);
        }

        .site-badge.ssl {
            background: rgba(52, 211, 153, 0.12);
            color: var(--success);
            border: 1px solid rgba(52, 211, 153, 0.2);
        }

        .site-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: var(--accent-light);
            color: var(--accent);
        }

        .icon-btn.danger:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .progress-container {
            margin-top: 24px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .progress-bar-bg {
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--primary);
        }

        .install-log {
            margin-top: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            max-height: 100px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* Slim Mode - Compact but readable */
        :root {
            --sidebar-width: 240px;
        }

        body[data-slim="true"] {
            --sidebar-width: 64px;
        }

        body[data-slim="true"] .sidebar {
            overflow-x: hidden;
        }

        body[data-slim="true"] .logo {
            padding: 16px 14px;
        }

        body[data-slim="true"] .logo-img {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        body[data-slim="true"] .logo-text {
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        body[data-slim="true"] .logo-version {
            font-size: 10px;
        }

        body[data-slim="true"] .main-content {
            margin-left: var(--sidebar-width);
            padding: 18px;
        }

        body[data-slim="true"] .page-header {
            margin-bottom: 16px;
        }

        body[data-slim="true"] .page-title {
            font-size: 20px;
        }

        body[data-slim="true"] .page-subtitle {
            font-size: 12px;
        }

        body[data-slim="true"] .stats-grid {
            gap: 12px;
        }

        body[data-slim="true"] .stat-card {
            padding: 14px;
            gap: 12px;
        }

        body[data-slim="true"] .stat-icon {
            width: 36px;
            height: 36px;
            padding: 9px;
        }

        body[data-slim="true"] .stat-icon svg {
            width: 18px;
            height: 18px;
        }

        body[data-slim="true"] .stat-label {
            font-size: 11px;
            margin-bottom: 3px;
        }

        body[data-slim="true"] .stat-value {
            font-size: 24px;
        }

        body[data-slim="true"] .card {
            margin-bottom: 14px;
        }

        body[data-slim="true"] .card-header {
            padding: 12px 14px;
        }

        body[data-slim="true"] .card-title {
            font-size: 13px;
            font-weight: 600;
        }

        body[data-slim="true"] .card-body {
            padding: 14px;
        }

        body[data-slim="true"] .list-item {
            padding: 10px 12px;
            gap: 12px;
        }

        body[data-slim="true"] .item-primary {
            font-size: 13px;
            font-weight: 500;
        }

        body[data-slim="true"] .item-secondary {
            font-size: 11px;
        }

        body[data-slim="true"] .site-row {
            padding: 10px 12px;
            gap: 12px;
        }

        body[data-slim="true"] .site-name {
            font-size: 14px;
        }

        body[data-slim="true"] .site-path {
            font-size: 11px;
        }

        body[data-slim="true"] .site-badge {
            padding: 3px 8px;
            font-size: 9px;
            border-radius: 8px;
        }

        body[data-slim="true"] .icon-btn {
            width: 28px;
            height: 28px;
        }

        body[data-slim="true"] .icon-btn svg {
            width: 13px;
            height: 13px;
        }

        body[data-slim="true"] .nav-item {
            padding: 10px 14px;
            gap: 10px;
        }

        body[data-slim="true"] .nav-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        body[data-slim="true"] .sidebar-footer {
            padding: 12px 14px;
        }

        body[data-slim="true"] .server-status {
            font-size: 11px;
            white-space: nowrap;
        }

        body[data-slim="true"] .server-status-dot {
            width: 7px;
            height: 7px;
            flex-shrink: 0;
        }

        body[data-slim="true"] .settings-row {
            padding: 12px 14px;
            gap: 12px;
        }

        body[data-slim="true"] .settings-label {
            font-size: 12px;
        }

        body[data-slim="true"] .settings-desc {
            font-size: 10px;
        }

        body[data-slim="true"] .settings-section-title {
            font-size: 11px;
            padding: 10px 14px;
        }

        body[data-slim="true"] .form-label {
            font-size: 12px;
            margin-bottom: 5px;
        }

        body[data-slim="true"] .form-hint {
            font-size: 10px;
            margin-top: 3px;
        }

        body[data-slim="true"] .input {
            padding: 9px 11px;
            font-size: 12px;
        }

        body[data-slim="true"] .form-select {
            padding: 9px 11px;
            font-size: 12px;
        }

        body[data-slim="true"] .toggle-switch {
            width: 32px;
            height: 18px;
            border-radius: 9px;
            border-width: 1.5px;
        }

        body[data-slim="true"] .toggle-switch::after {
            width: 12px;
            height: 12px;
            top: 1.5px;
            left: 1.5px;
        }

        body[data-slim="true"] .toggle-switch.active::after {
            left: 15.5px;
        }

        body[data-slim="true"] .sidebar {
            width: 200px;
        }

        body[data-slim="true"] .main-content {
            padding-bottom: 32px;
        }

        body[data-slim="true"] .nav-item {
            padding: 12px 16px;
        }

        body[data-slim="true"] .nav-item span {
            display: inline;
        }

        body[data-slim="true"] .nav-section {
            display: none;
        }

        body[data-slim="true"] .logo-text,
        body[data-slim="true"] .logo-version {
            display: block;
        }

        body[data-slim="true"] .logo {
            justify-content: center;
            padding: 12px 0;
        }

        body[data-slim="true"] .draw-panel {
            width: 400px;
        }

        .service-version-select {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            margin-right: 8px;
            outline: none;
        }

        .service-version-select:focus {
            border-color: var(--accent);
        }

        body[data-slim="true"] .draw-panel-header {
            padding: 12px 16px;
        }

        body[data-slim="true"] .draw-panel-title {
            font-size: 14px;
        }

        body[data-slim="true"] .draw-panel-body {
            padding: 14px;
        }

        body[data-slim="true"] .draw-panel-footer {
            padding: 12px 16px;
            gap: 10px;
        }

        body[data-slim="true"] .quick-actions {
            gap: 8px;
            flex-wrap: wrap;
        }

        body[data-slim="true"] .quick-actions .btn {
            padding: 8px 12px;
            font-size: 12px;
            gap: 7px;
        }

        body[data-slim="true"] .quick-actions .btn svg {
            width: 15px;
            height: 15px;
        }

        body[data-slim="true"] .status-badge {
            padding: 4px 8px;
            font-size: 10px;
            gap: 5px;
        }

        body[data-slim="true"] .status-dot {
            width: 6px;
            height: 6px;
        }

        body[data-slim="true"] .empty-state {
            padding: 36px 18px;
        }

        body[data-slim="true"] .empty-icon {
            width: 52px;
            height: 52px;
        }

        body[data-slim="true"] .empty-state p {
            font-size: 13px;
        }

        body[data-slim="true"] .progress-label {
            font-size: 12px;
        }

        body[data-slim="true"] .progress-bar-bg {
            height: 7px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div id="global-progress" class="global-progress">
            <div id="global-progress-bar" class="global-progress-bar"></div>
        </div>
        <!-- Icon Navigation (always visible) -->
        <nav class="icon-nav">
            <div class="icon-nav-logo" onclick="showPage('dashboard')" style="cursor: pointer;">
                <img src="/logo.png" alt="S" onerror="this.parentElement.innerHTML='S'">
                <span class="icon-nav-title">Stacker</span>
            </div>


            <button class="icon-nav-item" data-page="sites" title="Sites">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M2 12h20" />
                    <path
                        d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                </svg>
                <span class="icon-nav-label" data-i18n="nav.sites">Sites</span>
            </button>

            <button class="icon-nav-item" data-page="services" title="Services">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                </svg>
                <span class="icon-nav-label" data-i18n="nav.services">Services</span>
            </button>

            <button class="icon-nav-item" data-page="php" title="PHP">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="12" rx="10" ry="6" />
                </svg>
                <span class="icon-nav-label" data-i18n="nav.php">PHP</span>
            </button>

            <button class="icon-nav-item" data-page="dumps" title="Dumps">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                </svg>
                <span class="icon-nav-label" data-i18n="nav.dumps">Dumps</span>
            </button>

            <button class="icon-nav-item" data-page="mail" title="Mail">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                    <polyline points="22,6 12,13 2,6" />
                </svg>
                <span class="icon-nav-label" data-i18n="nav.mail">Mail</span>
            </button>

            <button class="icon-nav-item" data-page="logs" title="Logs">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <path d="M14 2v6h6" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
                <span class="icon-nav-label" data-i18n="nav.logs">Logs</span>
            </button>

            <div class="icon-nav-spacer"></div>

            <button class="icon-nav-item" data-page="about" title="About">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="16" x2="12" y2="12" />
                    <line x1="12" y1="8" x2="12.01" y2="8" />
                </svg>
                <span class="icon-nav-label" data-i18n="nav.about">About</span>
            </button>

            <button class="icon-nav-item" data-page="settings" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3" />
                    <path
                        d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                </svg>
                <span class="icon-nav-label" data-i18n="nav.settings">Settings</span>
            </button>

            <button class="icon-nav-toggle" onclick="toggleSitesPanel()" title="Toggle Panel">
                
            </button>
        </nav>

        <!-- Dynamic Panel (changes based on selected section) -->
        <aside class="sites-panel" id="sitesPanel">
            <div class="sites-panel-header" onclick="showPage('dashboard')" style="cursor: pointer;">
                <div class="sites-panel-title" id="panelTitle" data-i18n="dashboard.recent_sites">Local Sites</div>
                <input type="text" class="sites-panel-search" placeholder="Search..." id="panelSearch"
                    oninput="filterPanelList()" data-i18n="common.search">
            </div>
            <div class="sites-panel-list" id="panelList">
                <!-- Dynamic content will be rendered here -->
            </div>
        </aside>

        <!-- Floating Add Site Button -->
        <button class="add-site-btn" onclick="addSite()" title="Add New Site">+</button>

        <!-- Legacy sidebar (hidden) -->
        <aside class="sidebar">
            <div class="logo">
                <img src="/logo.png" class="logo-img" alt="Stacker" onerror="this.style.display='none'">
                <div>
                    <div class="logo-text">Stacker</div>
                    <div class="logo-version">v1.0.0</div>
                </div>
            </div>

            <nav class="nav">
                <div class="nav-section">Overview</div>
                <button class="nav-item active" data-page="dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1" />
                        <rect x="14" y="3" width="7" height="7" rx="1" />
                        <rect x="3" y="14" width="7" height="7" rx="1" />
                        <rect x="14" y="14" width="7" height="7" rx="1" />
                    </svg>
                    <span>Dashboard</span>
                </button>

                <div class="nav-section">Development</div>
                <button class="nav-item" data-page="sites">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M2 12h20" />
                        <path
                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                    </svg>
                    <span>Sites</span>
                </button>
                <button class="nav-item" data-page="services">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                    </svg>
                    <span>Services</span>
                </button>
                <button class="nav-item" data-page="php">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <ellipse cx="12" cy="12" rx="10" ry="6" />
                        <path d="M6 12l2-4h2l-1 2h1l1-2h2l-2 4" />
                    </svg>
                    <span>PHP</span>
                </button>

                <div class="nav-section">Tools</div>
                <button class="nav-item" data-page="dumps">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg>
                    <span>Dumps</span>
                </button>
                <button class="nav-item" data-page="mail">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                        <polyline points="22,6 12,13 2,6" />
                    </svg>
                    <span>Mail</span>
                </button>
                <button class="nav-item" data-page="logs">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <path d="M14 2v6h6" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                    <span>Logs</span>
                </button>

                <div class="nav-section">Info</div>
                <button class="nav-item" data-page="changelog">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="12" y1="18" x2="12" y2="12" />
                        <line x1="9" y1="15" x2="15" y2="15" />
                    </svg>
                    <span>Change Log</span>
                </button>
                <button class="nav-item" data-page="about">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="16" x2="12" y2="12" />
                        <line x1="12" y1="8" x2="12.01" y2="8" />
                    </svg>
                    <span>About</span>
                </button>
                <div class="nav-section">System</div>
                <button class="nav-item" data-page="settings">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    <span>Settings</span>
                </button>
            </nav>
        </aside>

        <div class="status-bar">
            <div class="status-bar-item">
                <span class="server-status-dot"></span>
                <span id="server-status-text">Server running on :9999</span>
            </div>
        </div>

        <main class="main-content">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">


                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon sites">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M2 12h20" />
                            </svg>
                        </div>
                        <div class="stat-label">Sites</div>
                        <div class="stat-value" id="stat-sites">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon services">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                            </svg>
                        </div>
                        <div class="stat-label">Running Services</div>
                        <div class="stat-value" id="stat-services">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon dumps">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                        </div>
                        <div class="stat-label">Dumps</div>
                        <div class="stat-value" id="stat-dumps">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon php">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <ellipse cx="12" cy="12" rx="10" ry="6" />
                            </svg>
                        </div>
                        <div class="stat-label">PHP Version</div>
                        <div class="stat-value" id="stat-php">-</div>
                    </div>
                </div>

                <!-- Quick Access Grid -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Recent Sites -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Recent Sites</span>
                            <button class="btn" onclick="showPage('sites')"
                                style="padding: 6px 12px; font-size: 12px;">View All</button>
                        </div>
                        <div class="card-body" id="recent-sites" style="padding: 0;"></div>
                    </div>

                    <!-- Quick Services -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Services</span>
                            <button class="btn" onclick="showPage('services')"
                                style="padding: 6px 12px; font-size: 12px;">Manage</button>
                        </div>
                        <div class="card-body" id="quick-services" style="padding: 16px;"></div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Quick Actions</span>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="showPage('sites'); setTimeout(() => addSite(), 100)">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="12" y1="8" x2="12" y2="16" />
                                <line x1="8" y1="12" x2="16" y2="12" />
                            </svg>
                            Add New Site
                        </button>
                        <button class="btn btn-success" onclick="openTerminal()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="4 17 10 11 4 5" />
                                <line x1="12" y1="19" x2="20" y2="19" />
                            </svg>
                            Open Terminal
                        </button>
                        <button class="btn" onclick="location.reload()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="23 4 23 10 17 10" />
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                            </svg>
                            Refresh
                        </button>
                        <button class="btn" onclick="showPage('services')">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                            </svg>
                            Manage Services
                        </button>
                        <button class="btn" onclick="showPage('dumps')">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                            View Dumps
                        </button>
                        <button class="btn" onclick="showPage('mail')">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                <polyline points="22,6 12,13 2,6" />
                            </svg>
                            View Mail
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sites -->
            <div id="sites" class="page">
                <div class="page-header">
                    <h1 class="page-title">Sites</h1>
                    <p class="page-subtitle">Manage your local development sites</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Sites</span>
                        <button class="btn btn-primary" onclick="addSite()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            Add Site
                        </button>
                    </div>
                    <div class="card-body" id="sites-list"></div>
                </div>
            </div>

            <!-- Services -->
            <div id="services" class="page">
                <div class="page-header">
                    <h1 class="page-title">Services</h1>
                    <p class="page-subtitle">Manage database and cache services</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Services</span>
                    </div>
                    <div class="card-body" id="services-list"></div>
                </div>
            </div>

            <!-- Dumps -->
            <div id="dumps" class="page">
                <div class="page-header">
                    <h1 class="page-title">Dumps</h1>
                    <p class="page-subtitle">View debug dumps from your applications</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Dumps</span>
                        <button class="btn btn-danger" onclick="clearDumps()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="3 6 5 6 21 6" />
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                            </svg>
                            Clear All
                        </button>
                    </div>
                    <div class="card-body" id="dumps-list"></div>
                </div>
            </div>

            <!-- Mail -->
            <div id="mail" class="page">
                <div class="page-header">
                    <h1 class="page-title">Mail</h1>
                    <p class="page-subtitle">Captured emails from your applications</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Inbox</span>
                        <button class="btn btn-danger" onclick="clearMail()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="3 6 5 6 21 6" />
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                            </svg>
                            Clear All
                        </button>
                    </div>
                    <div class="card-body" id="mail-list"></div>
                </div>
            </div>

            <!-- Logs -->
            <div id="logs" class="page">
                <div class="page-header">
                    <h1 class="page-title">Logs</h1>
                    <p class="page-subtitle">View and search application logs</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Log Files</span>
                    </div>
                    <div class="card-body" id="logs-list"></div>
                </div>
            </div>

            <!-- PHP -->
            <div id="php" class="page">
                <div class="page-header">
                    <h1 class="page-title">PHP Versions</h1>
                    <p class="page-subtitle">Manage installed PHP versions</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Installed Versions</span>
                        <button class="btn btn-primary" onclick="openInstallPHP()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            Install PHP
                        </button>
                    </div>
                    <div class="card-body" id="php-list"></div>
                </div>
            </div>

            <!-- Change Log -->
            <div id="changelog" class="page">
                <div class="page-header">
                    <h1 class="page-title">Change Log</h1>
                    <p class="page-subtitle">Stacker update history</p>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 32px;">
                        <div
                            style="border-left: 3px solid var(--accent); padding-left: 24px; margin-bottom: 40px; position: relative;">
                            <div
                                style="position: absolute; left: -8px; top: 0; width: 13px; height: 13px; background: var(--accent); border-radius: 50%; border: 3px solid var(--bg-secondary);">
                            </div>
                            <h3 style="margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                                v1.0.1
                                <span class="status-badge"
                                    style="background: var(--accent-light); color: var(--accent); border: none;">Latest</span>
                            </h3>
                            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">January 1, 2026
                            </p>
                            <ul style="padding-left: 18px; line-height: 2; color: var(--text-secondary);">
                                <li><strong>Composer Integration</strong>: Download and manage `composer.phar` directly.
                                </li>
                                <li><strong>Node.js Support</strong>: Install multiple Node.js versions with npm
                                    inclusion.</li>
                                <li><strong>Real-time Health Checks</strong>: Automatic service monitoring via PID and
                                    Port scanning.</li>
                                <li><strong>Custom Dialogs</strong>: Replaced browser alerts with modern, consistent UI
                                    modals.</li>
                                <li><strong>Aesthetic Refinements</strong>: Perfected toggle switches and layout
                                    spacing.</li>
                                <li><strong>New Info Hub</strong>: Added dedicated About and Change Log views.</li>
                            </ul>
                        </div>
                        <div style="border-left: 3px solid var(--border); padding-left: 24px; position: relative;">
                            <div
                                style="position: absolute; left: -8px; top: 0; width: 13px; height: 13px; background: var(--border); border-radius: 50%; border: 3px solid var(--bg-secondary);">
                            </div>
                            <h3 style="margin-bottom: 8px; color: var(--text-primary);">v1.0.0</h3>
                            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">December 20, 2025
                            </p>
                            <ul style="padding-left: 18px; line-height: 2; color: var(--text-muted);">
                                <li>Initial standalone release with dynamic configuration.</li>
                                <li>Support for PHP, Nginx, Apache, MySQL, MariaDB, and Redis.</li>
                                <li>Basic site management and log viewing.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About -->
            <div id="about" class="page">
                <div class="page-header">
                    <h1 class="page-title">About</h1>
                    <p class="page-subtitle">System information and credits</p>
                </div>
                <div class="card" style="padding: 60px 40px; text-align: center;">
                    <div
                        style="background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); width: 88px; height: 88px; border-radius: 22px; margin: 0 auto 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 12px 24px var(--shadow-lg);">
                        <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                        </svg>
                    </div>
                    <h2 style="font-size: 28px; margin-bottom: 12px; letter-spacing: -0.5px;">Stacker</h2>
                    <p style="color: var(--text-muted); font-size: 15px; margin-bottom: 32px;">Version 1.0.1 Stable
                        (macOS Edition)</p>

                    <p
                        style="max-width: 520px; margin: 0 auto 48px; line-height: 1.8; color: var(--text-secondary); font-size: 16px;">
                        Stacker is a modern, standalone development environment crafted for high-performance web
                        development.
                        It empowers developers to manage multiple PHP versions, databases, and servers without local
                        system dependencies.
                    </p>

                    <div
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; text-align: left; max-width: 440px; margin: 0 auto;">
                        <div
                            style="padding: 20px; background: var(--bg-tertiary); border-radius: 16px; border: 1px solid var(--border);">
                            <div
                                style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; letter-spacing: 1px;">
                                Developer</div>
                            <div style="font-weight: 600; font-size: 15px;">Insya</div>
                        </div>
                        <div
                            style="padding: 20px; background: var(--bg-tertiary); border-radius: 16px; border: 1px solid var(--border);">
                            <div
                                style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; letter-spacing: 1px;">
                                License</div>
                            <div style="font-weight: 600; font-size: 15px;">MIT Open Source</div>
                        </div>
                    </div>

                    <div style="margin-top: 48px;">
                        <a href="https://github.com/yasinkuyu/Stacker" target="_blank" class="btn"
                            style="padding: 12px 32px; border-radius: 12px; font-weight: 600;">View on GitHub</a>
                    </div>
                </div>
            </div>
            <!-- Settings -->
            <div id="settings" class="page">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                    <p class="page-subtitle">Configure Stacker to your preferences</p>
                </div>

                <div class="card">
                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="settings.language">Language</div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label" data-i18n="settings.language">Interface Language</div>
                                <div class="settings-desc">Choose your preferred application language</div>
                            </div>
                            <select class="input" id="lang-select" onchange="changeLanguage(this.value)"
                                style="width: auto;">
                                <option value="en">English</option>
                                <option value="tr">Trke</option>
                                <option value="ar"> (Arabic)</option>
                                <option value="de">Deutsch</option>
                                <option value="fr">Franais</option>
                                <option value="es">Espaol</option>
                                <option value="it">Italiano</option>
                                <option value="pt">Portugus</option>
                                <option value="ru"></option>
                                <option value="zh"> (Chinese)</option>
                                <option value="ja"> (Japanese)</option>
                                <option value="ko"> (Korean)</option>
                                <option value="hi"> (Hindi)</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="settings.general">General</div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Automated Start</div>
                                <div class="settings-desc">Start services automatically when Stacker opens</div>
                            </div>
                            <button class="toggle-switch" id="auto-start-toggle" onclick="toggleAutoStart()"></button>
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">System Tray</div>
                                <div class="settings-desc">Minimize to system tray instead of closing</div>
                            </div>
                            <button class="toggle-switch" id="tray-toggle" onclick="toggleTray()"></button>
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Slim Mode</div>
                                <div class="settings-desc">Compact sidebar for more screen space</div>
                            </div>
                            <button class="toggle-switch" id="slim-mode-toggle" onclick="toggleSlimMode()"></button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="settings.appearance">Appearance</div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label" data-i18n="settings.theme">Theme</div>
                                <div class="settings-desc">Choose your preferred interface style</div>
                            </div>
                            <div class="theme-toggle">
                                <button class="theme-btn active" data-theme="light" onclick="setTheme('light')"
                                    title="Light">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="12" cy="12" r="5" />
                                        <line x1="12" y1="1" x2="12" y2="3" />
                                        <line x1="12" y1="21" x2="12" y2="23" />
                                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                                        <line x1="1" y1="12" x2="3" y2="12" />
                                        <line x1="21" y1="12" x2="23" y2="12" />
                                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                                    </svg>
                                </button>
                                <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')" title="Dark">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">Ports</div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Apache Port</div>
                                <div class="settings-desc">Port used by Apache server</div>
                            </div>
                            <input type="number" class="input" id="apache-port-input" style="width: 100px;"
                                onblur="savePorts()">
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Nginx Port</div>
                                <div class="settings-desc">Port used by Nginx server</div>
                            </div>
                            <input type="number" class="input" id="nginx-port-input" style="width: 100px;"
                                onblur="savePorts()">
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">MySQL Port</div>
                                <div class="settings-desc">Port used by MySQL server</div>
                            </div>
                            <input type="number" class="input" id="mysql-port-input" style="width: 100px;"
                                onblur="savePorts()">
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Presets</div>
                                <div class="settings-desc">Set ports to common defaults</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn" style="padding: 6px 12px; font-size: 11px;"
                                    onclick="setPortPreset('stacker')">Stacker default</button>
                                <button class="btn" style="padding: 6px 12px; font-size: 11px;"
                                    onclick="setPortPreset('common')">80 & 3306</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="nav.logs">Navigation</div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Expanded Navigation</div>
                                <div class="settings-desc">Show labels next to navigation icons</div>
                            </div>
                            <button class="toggle-switch" id="expanded-nav-toggle"
                                onclick="toggleExpandedNav()"></button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">Network</div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Web UI Port</div>
                                <div class="settings-desc">Port used for this dashboard (requires reload)</div>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <input type="number" class="input" id="port-input" value="9999" style="width:100px;">
                                <button class="btn btn-primary" onclick="savePort()">Save</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="services.title">Built-in Services</div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">
                                    <span style="display:inline-flex;align-items:center;gap:8px;">
                                        <span
                                            style="width:8px;height:8px;border-radius:50%;background:#10b981;display:inline-block;"></span>
                                        SMTP Server
                                    </span>
                                </div>
                                <div class="settings-desc">Local mail server for catching outgoing emails from your apps
                                </div>
                            </div>
                            <div style="display:flex;gap:12px;align-items:center;">
                                <span style="font-size:12px;color:var(--text-muted);">Port: 1025</span>
                                <span class="status-badge status-running"><span class="status-dot"></span>Running</span>
                            </div>
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Mail Catcher</div>
                                <div class="settings-desc">View captured emails in the Mail section</div>
                            </div>
                            <button class="btn" onclick="showPage('mail')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                    <polyline points="22,6 12,13 2,6" />
                                </svg>
                                View Emails
                            </button>
                        </div>
                        <div class="settings-row"
                            style="background:var(--bg-tertiary);border-radius:8px;padding:12px;margin-top:8px;">
                            <div style="font-size:12px;color:var(--text-muted);">
                                <strong>SMTP Configuration for your apps:</strong><br>
                                <code
                                    style="background:var(--bg-hover);padding:2px 6px;border-radius:4px;font-family:'SF Mono',Monaco,monospace;">
                                    Host: localhost &nbsp;|&nbsp; Port: 1025 &nbsp;|&nbsp; No authentication required
                                </code>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">Support</div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Check for Updates</div>
                                <div class="settings-desc">Currently running version 1.0.1</div>
                            </div>
                            <button class="btn" onclick="checkUpdates()">Check Now</button>
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Maintenance</div>
                                <div class="settings-desc">Clean up temporary files and logs</div>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn" onclick="clearDumps()">Clear Dumps</button>
                                <button class="btn" onclick="clearMail()">Clear Mail</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer Bar -->
        <footer class="footer-bar">
            <div class="footer-left">
                <button id="btn-start-all" class="footer-btn footer-btn-start" onclick="startAllServers()">
                    <svg class="btn-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    <span data-i18n="footer.start_all">Start All</span>
                </button>
                <button id="btn-stop-all" class="footer-btn footer-btn-stop" onclick="stopAllServers()">
                    <svg class="btn-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12" />
                    </svg>
                    <span data-i18n="footer.stop_all">Stop All</span>
                </button>
            </div>
            <div class="footer-right">
                <span class="footer-brand" onclick="showPage('about')" style="cursor:pointer">Stacker</span>
                <span class="footer-version" onclick="showChangeLog()" style="cursor:pointer">v1.0.0</span>
                <span class="footer-copyright"> 2026 Insya, Yasin Kuyu</span>
            </div>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toast-message"></span>
    </div>

    <!-- Draw Panel Overlay -->
    <div class="draw-panel-overlay" id="drawPanelOverlay" onclick="closeDrawPanel()"></div>

    <div class="draw-panel" id="drawPanel">
        <div class="draw-panel-header">
            <h2 class="draw-panel-title" id="drawPanelTitle" data-i18n="common.config">Title</h2>
            <button class="draw-panel-close" onclick="closeDrawPanel()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="draw-panel-body" id="drawPanelBody">
            <!-- Content dynamicly loaded -->
        </div>
        <div class="draw-panel-footer" id="drawPanelFooter">
            <button class="btn" onclick="closeDrawPanel()" data-i18n="common.cancel">Cancel</button>
            <button class="btn btn-primary" id="drawPanelSave" data-i18n="common.save">Save</button>
        </div>
    </div>

    <!-- Custom Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle" data-i18n="common.confirm">Confirm</span>
                <button class="modal-close" id="modalClose">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalMessage">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button class="btn" id="modalCancel" data-i18n="common.cancel">Cancel</button>
                <button class="btn btn-primary" id="modalConfirm" data-i18n="common.confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // i18n & Localization Engine
        // ==========================================
        let currentLang = localStorage.getItem('stacker_lang') || 'en';
        let translations = {};

        async function loadTranslations(lang) {
            try {
                const res = await fetch(`/api/locales/${lang}`);
                if (!res.ok) throw new Error('Failed to load locale');
                translations = await res.json();
                applyTranslations();
                updateRTL(lang);

                // Sync select input if it exists
                const select = document.getElementById('lang-select');
                if (select) select.value = lang;
            } catch (err) {
                console.error('i18n Error:', err);
                if (lang !== 'en') loadTranslations('en');
            }
        }

        function t(path) {
            const keys = path.split('.');
            let result = translations;
            for (const key of keys) {
                if (result[key]) {
                    result = result[key];
                } else {
                    return path;
                }
            }
            return result;
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const translation = t(key);
                if (translation !== key) {
                    if (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'search')) {
                        el.placeholder = translation;
                    } else {
                        el.innerText = translation;
                    }
                }
            });
        }

        function updateRTL(lang) {
            const isRTL = lang === 'ar';
            document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;

            // Mirroring styles for RTL if needed
            if (isRTL) {
                document.body.classList.add('rtl-mode');
            } else {
                document.body.classList.remove('rtl-mode');
            }
        }

        async function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('stacker_lang', lang);
            await loadTranslations(lang);
            showToast(t('common.save') || 'Language changed', 'success');

            // Save to backend
            await api('/preferences', 'PUT', { language: lang });
        }

        // Initialize i18n
        loadTranslations(currentLang);

        // ==========================================
        // UI & Navigation (New 3-Column Layout)
        // ==========================================

        // Icon Nav click handlers
        document.querySelectorAll('.icon-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.icon-nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const page = item.dataset.page;
                showPage(page);
                updatePanelForSection(page);
            });
        });

        // Legacy nav-item handlers (kept for compatibility)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => showPage(item.dataset.page));
        });

        // Toggle Sites Panel
        function toggleSitesPanel() {
            const body = document.body;
            const toggle = document.querySelector('.icon-nav-toggle');
            const isCollapsed = body.getAttribute('data-panel-collapsed') === 'true';

            body.setAttribute('data-panel-collapsed', !isCollapsed);
            toggle.textContent = isCollapsed ? '' : '';

            // Save preference
            localStorage.setItem('panelCollapsed', !isCollapsed);
        }

        // Restore panel state
        if (localStorage.getItem('panelCollapsed') === 'true') {
            document.body.setAttribute('data-panel-collapsed', 'true');
            document.querySelector('.icon-nav-toggle').textContent = '';
        }

        // Current active panel section
        let currentPanelSection = 'sites';

        // Panel section configurations
        const panelConfig = {
            dashboard: { title: 'Dashboard', placeholder: '' },
            sites: { title: 'Local Sites', placeholder: 'Search sites...' },
            services: { title: 'Services', placeholder: 'Search services...' },
            php: { title: 'PHP Versions', placeholder: 'Search PHP...' },
            dumps: { title: 'Dumps', placeholder: 'Search dumps...' },
            mail: { title: 'Inbox', placeholder: 'Search mail...' },
            settings: { title: 'Settings', placeholder: '' },
            logs: { title: 'Log Files', placeholder: 'Search logs...' }
        };

        // Update panel for active section
        function updatePanelForSection(section) {
            currentPanelSection = section;
            const config = panelConfig[section] || { title: section, placeholder: 'Search...' };

            document.getElementById('panelTitle').textContent = config.title;
            document.getElementById('panelSearch').placeholder = config.placeholder;
            document.getElementById('panelSearch').style.display = config.placeholder ? 'block' : 'none';

            // Render appropriate content
            switch (section) {
                case 'dashboard': renderDashboardPanelList(); break;
                case 'sites': renderSitesPanelList(cachedSites); break;
                case 'services': renderServicesPanelList(); break;
                case 'php': renderPHPPanelList(); break;
                case 'dumps': renderDumpsPanelList(); break;
                case 'mail': renderMailPanelList(); break;
                default: renderDefaultPanelList(section);
            }
        }

        // Initialize dashboard panel
        function renderDashboardPanelList() {
            renderSitesPanelList(cachedSites);
        }

        // Render sites panel list
        function renderSitesPanelList(sites) {
            const list = document.getElementById('panelList');
            if (!sites || !sites.length) {
                list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px;">No sites yet</div>';
                return;
            }

            list.innerHTML = sites.map(s => `
                <div class="site-list-item" onclick="selectSite('${s.name}')">
                    <span class="site-status-dot ${s.status || 'stopped'}"></span>
                    <span class="site-list-name">${s.name.toUpperCase()}</span>
                </div>
            `).join('');
        }

        // Render services panel list
        function renderServicesPanelList() {
            const list = document.getElementById('panelList');
            if (!cachedServices || !cachedServices.length) {
                list.innerHTML = `
                    <div class="panel-empty">
                        <div class="panel-empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                        </div>
                        <div class="panel-empty-title">Get Started</div>
                        <div class="panel-empty-desc">Install MySQL, Redis, or Apache to power your sites.</div>
                        <button class="btn btn-primary btn-sm" onclick="showPage('services')">Browse Services</button>
                    </div>
                `;
                return;
            }
            const running = cachedServices.filter(s => s.status === 'running').length;
            list.innerHTML = `
                <div class="panel-stats">
                    <div class="panel-stat">
                        <span class="panel-stat-value">${running}</span>
                        <span class="panel-stat-label">Running</span>
                    </div>
                    <div class="panel-stat">
                        <span class="panel-stat-value">${cachedServices.length}</span>
                        <span class="panel-stat-label">Installed</span>
                    </div>
                </div>
            ` + cachedServices.map(s => `
                <div class="site-list-item" onclick="showPage('services')">
                    <span class="site-status-dot ${s.status === 'running' ? 'running' : 'stopped'}"></span>
                    <span class="site-list-name">${s.name.toUpperCase()}</span>
                </div>
            `).join('');
        }

        // Render PHP panel list
        function renderPHPPanelList() {
            const list = document.getElementById('panelList');
            if (!cachedPHP || !cachedPHP.length) {
                list.innerHTML = `
                    <div class="panel-empty">
                        <div class="panel-empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 20h20"></path>
                                <path d="M5 20V8a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v12"></path>
                                <path d="M9 10h6"></path>
                                <path d="M9 14h6"></path>
                            </svg>
                        </div>
                        <div class="panel-empty-title">PHP Versions</div>
                        <div class="panel-empty-desc">Install multiple PHP versions and switch between them.</div>
                        <button class="btn btn-primary btn-sm" onclick="showPage('php')">Install PHP</button>
                    </div>
                `;
                return;
            }
            const defaultPHP = cachedPHP.find(p => p.default);
            list.innerHTML = `
                <div class="panel-info-box">
                    <div class="panel-info-label">Default Version</div>
                    <div class="panel-info-value">PHP ${defaultPHP ? defaultPHP.version : '-'}</div>
                </div>
            ` + cachedPHP.map(p => `
                <div class="site-list-item" onclick="showPage('php')">
                    <span class="site-status-dot ${p.default ? 'running' : 'stopped'}"></span>
                    <span class="site-list-name">PHP ${p.version}</span>
                </div>
            `).join('');
        }

        // Render dumps panel list
        function renderDumpsPanelList() {
            const list = document.getElementById('panelList');
            list.innerHTML = `
                <div class="panel-empty">
                    <div class="panel-empty-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                    </div>
                    <div class="panel-empty-title">Dumps</div>
                    <div class="panel-empty-desc">Use <code>dump()</code> in your PHP code to see output here.</div>
                </div>
                <div class="panel-tip">
                    <strong>Tip:</strong> Add <code>require 'stacker.php'</code> to your project.
                </div>
            `;
        }

        // Render mail panel list
        function renderMailPanelList() {
            const list = document.getElementById('panelList');
            list.innerHTML = `
                <div class="panel-empty">
                    <div class="panel-empty-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                    </div>
                    <div class="panel-empty-title">Mail Catcher</div>
                    <div class="panel-empty-desc">SMTP on port 1015 catches all outgoing mail.</div>
                </div>
                <div class="panel-tip">
                    <strong>Config:</strong> Set SMTP to <code>localhost:1025</code>
                </div>
            `;
        }

        // Render default panel list
        function renderDefaultPanelList(section) {
            const list = document.getElementById('panelList');
            const content = {
                'about': `
                    <div class="panel-empty">
                        <div class="panel-empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                        </div>
                        <div class="panel-empty-title">Stacker</div>
                        <div class="panel-empty-desc">Local development environment for macOS.</div>
                    </div>
                    <div class="panel-tip">Version 1.0.0</div>
                `,
                'settings': `
                    <div class="panel-quick-links">
                        <div class="panel-quick-link" onclick="setTheme('dark')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:middle;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                            Dark Theme
                        </div>
                        <div class="panel-quick-link" onclick="setTheme('light')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:middle;"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                            Light Theme
                        </div>
                        <div class="panel-quick-link" onclick="toggleExpandedNav()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:middle;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                            Toggle Nav Size
                        </div>
                    </div>
                `,
                'logs': `
                    <div class="panel-empty">
                        <div class="panel-empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </div>
                        <div class="panel-empty-title">Logs</div>
                        <div class="panel-empty-desc">View Nginx, PHP, and service logs.</div>
                    </div>
                `
            };
            list.innerHTML = content[section] || `
                <div class="panel-empty">
                    <div class="panel-empty-icon"></div>
                    <div class="panel-empty-title">${section}</div>
                </div>
            `;
        }

        // Filter panel list
        function filterPanelList() {
            const query = document.getElementById('panelSearch').value.toLowerCase();
            const items = document.querySelectorAll('.site-list-item');
            items.forEach(item => {
                const name = item.querySelector('.site-list-name').textContent.toLowerCase();
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        }

        // Select a site (show detail view)
        let selectedSite = null;
        function selectSite(name) {
            selectedSite = name;
            document.querySelectorAll('.site-list-item').forEach(item => {
                item.classList.toggle('active', item.querySelector('.site-list-name').textContent.toLowerCase() === name.toLowerCase());
            });
            // Navigate to sites page and trigger edit
            showPage('sites');
            setTimeout(() => {
                const site = cachedSites.find(s => s.name === name);
                if (site) editSite(site);
            }, 100);
        }

        // Stop all sites (placeholder)
        function stopAllSites() {
            showToast('Stopping all sites...', 'warning');
        }

        // Global Progress Logic
        function showGlobalProgress() {
            const el = document.getElementById('global-progress');
            const bar = document.getElementById('global-progress-bar');
            if (el && bar) {
                el.style.display = 'block';
                bar.style.width = '0%';
            }
        }

        function updateGlobalProgress(percent) {
            const bar = document.getElementById('global-progress-bar');
            if (bar) bar.style.width = percent + '%';
        }

        function hideGlobalProgress() {
            updateGlobalProgress(100);
            setTimeout(() => {
                const el = document.getElementById('global-progress');
                if (el) el.style.display = 'none';
            }, 400);
        }


        // Start all servers
        async function startAllServers() {
            const btn = document.getElementById('btn-start-all');
            if (btn) setButtonLoading(btn, true, 'Starting...');

            try {
                showToast('Starting all servers...', 'info');
                showGlobalProgress();

                const servicesToStart = cachedServices.filter(s => s.status !== 'running');
                if (servicesToStart.length === 0) {
                    updateGlobalProgress(100);
                    setTimeout(hideGlobalProgress, 500);
                    showToast('All servers are already running');
                    return;
                }

                let completed = 0;
                for (const service of servicesToStart) {
                    await api(`/services/start/${service.name}`, 'POST');
                    completed++;
                    updateGlobalProgress((completed / servicesToStart.length) * 100);
                }

                showToast('All servers started successfully!');
                loadServices();
                setTimeout(hideGlobalProgress, 500);
            } catch (err) {
                hideGlobalProgress();
                showToast('Error starting servers: ' + err.message, 'error');
            } finally {
                if (btn) setButtonLoading(btn, false);
            }
        }

        // Stop all servers
        async function stopAllServers() {
            const btn = document.getElementById('btn-stop-all');
            if (btn) setButtonLoading(btn, true, 'Stopping...');

            try {
                showToast('Stopping all servers...', 'warning');
                showGlobalProgress();

                const servicesToStop = cachedServices.filter(s => s.status === 'running');
                if (servicesToStop.length === 0) {
                    updateGlobalProgress(100);
                    setTimeout(hideGlobalProgress, 500);
                    showToast('All servers are already stopped');
                    return;
                }

                let completed = 0;
                for (const service of servicesToStop) {
                    await api(`/services/stop/${service.name}`, 'POST');
                    completed++;
                    updateGlobalProgress((completed / servicesToStop.length) * 100);
                }

                showToast('All servers stopped successfully!');
                loadServices();
                setTimeout(hideGlobalProgress, 500);
            } catch (err) {
                hideGlobalProgress();
                showToast('Error stopping servers: ' + err.message, 'error');
            } finally {
                if (btn) setButtonLoading(btn, false);
            }
        }

        // Update running sites count
        function updateRunningSitesCount() {
            // For now, just show site count
            const count = cachedSites ? cachedSites.length : 0;
            const el = document.getElementById('runningSitesCount');
            if (el) el.textContent = count;
        }

        // Cache data for panel
        let cachedSites = [];
        let cachedServices = [];
        let cachedPHP = [];

        // Initialize panel on load
        document.addEventListener('DOMContentLoaded', () => {
            updatePanelForSection('sites');
        });

        // Custom Modal UI
        const customModal = {
            overlay: document.getElementById('modalOverlay'),
            title: document.getElementById('modalTitle'),
            message: document.getElementById('modalMessage'),
            confirmBtn: document.getElementById('modalConfirm'),
            cancelBtn: document.getElementById('modalCancel'),
            closeBtn: document.getElementById('modalClose'),

            show(options) {
                this.title.textContent = options.title || 'Confirm';
                this.message.innerHTML = options.message || '';
                this.confirmBtn.textContent = options.confirmText || 'Confirm';
                this.confirmBtn.className = 'btn ' + (options.type === 'danger' ? 'btn-danger' : 'btn-primary');

                if (options.hideCancel) {
                    this.cancelBtn.style.display = 'none';
                } else {
                    this.cancelBtn.style.display = 'block';
                    this.cancelBtn.textContent = options.cancelText || 'Cancel';
                }

                this.overlay.classList.add('open');

                return new Promise((resolve) => {
                    const onConfirm = () => {
                        this.overlay.classList.remove('open');
                        window.removeEventListener('keydown', onEsc);
                        resolve(true);
                    };
                    const onCancel = () => {
                        this.overlay.classList.remove('open');
                        window.removeEventListener('keydown', onEsc);
                        resolve(false);
                    };
                    const onEsc = (e) => { if (e.key === 'Escape') onCancel(); };

                    this.confirmBtn.onclick = onConfirm;
                    this.cancelBtn.onclick = onCancel;
                    this.closeBtn.onclick = onCancel;
                    this.overlay.onclick = (e) => { if (e.target === this.overlay) onCancel(); };
                    window.addEventListener('keydown', onEsc);
                });
            }
        };

        const ui = {
            confirm: (message, options = {}) => customModal.show({ message, ...options }),
            alert: (message, options = {}) => customModal.show({ message, hideCancel: true, confirmText: 'OK', ...options })
        };

        function getServiceIcon(type) {
            const icons = {
                'nginx': '<img src="/static/services/nginx.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'apache': '<img src="/static/services/apache.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'mysql': '<img src="/static/services/mysql.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'mariadb': '<img src="/static/services/mariadb.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'php': '<img src="/static/services/php.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'redis': '<img src="/static/services/redis.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'memcached': '<img src="/static/services/memcached.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'postgresql': '<img src="/static/services/postgresql.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'mongodb': '<img src="/static/services/mongodb.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">',
                'elasticsearch': '<img src="/static/services/elasticsearch.svg" width="24" height="24" onerror="this.src=\'/static/logo.png\'">'
            };
            return icons[type] || '<img src="/static/logo.png" width="24" height="24">';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.icon-nav-item').forEach(n => n.classList.remove('active'));

            const page = document.getElementById(pageId);
            if (page) page.classList.add('active');

            const navs = document.querySelectorAll('[data-page="' + pageId + '"]');
            navs.forEach(n => n.classList.add('active'));

            updatePanelForSection(pageId);
            window.location.hash = pageId;
            loadPage(pageId);
        }

        async function api(endpoint, method = 'GET', data = null) {
            try {
                const options = { method };
                if (data) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(data);
                }
                const res = await fetch('/api' + endpoint, options);
                if (!res.ok) {
                    const error = await res.json().catch(() => ({}));
                    throw new Error(error.message || `API error: ${res.status}`);
                }
                return res.json();
            } catch (err) {
                console.error('API Error:', err);
                throw err;
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toast.className = 'toast show ' + type;
            toastMessage.textContent = message;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Standardized Button Loading State
        function setButtonLoading(btn, isLoading, loadingText = '') {
            if (!btn) return;

            if (isLoading) {
                // If already loading, do nothing
                if (btn.classList.contains('btn-loading')) return;

                // Store original HTML if not already stored
                if (!btn.dataset.originalHtml) {
                    btn.dataset.originalHtml = btn.innerHTML;
                }

                const text = loadingText || btn.innerText.trim();
                btn.style.width = getComputedStyle(btn).width; // Lock width
                btn.classList.add('btn-loading');
                btn.innerHTML = `<span class="spinner-sm"></span> <span>${text}</span>`;
            } else {
                btn.classList.remove('btn-loading');
                // Restore original HTML
                if (btn.dataset.originalHtml) {
                    btn.innerHTML = btn.dataset.originalHtml;
                }
                btn.style.width = ''; // Release width
            }
        }

        // ==========================================
        // Data Loading
        // ==========================================

        async function loadPage(pageId) {
            switch (pageId) {
                case 'dashboard': await loadStatus(); break;
                case 'sites': await loadSites(); break;
                case 'services': await loadServices(); break;
                case 'dumps': await loadDumps(); break;
                case 'mail': await loadMail(); break;
                case 'logs': await loadLogs(); break;
                case 'php': await loadPHP(); break;
                case 'settings': await loadSettings(); break;
            }
        }

        async function loadPHP() {
            const list = document.getElementById('php-list');

            // Show loading spinner
            list.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; gap: 16px;">
                    <div class="spinner"></div>
                    <span style="color: var(--text-muted); font-size: 13px;">Loading PHP versions...</span>
                </div>
            `;

            try {
                const data = await api('/php');
                if (!data || !data.versions || data.versions.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state" style="padding: 40px; text-align: center;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" style="margin-bottom: 16px;">
                                <ellipse cx="12" cy="12" rx="10" ry="6"/>
                                <path d="M5.5 8.5l2.5 7h2l1-3h2l1 3h2l2.5-7"/>
                            </svg>
                            <h3 style="color: var(--text-muted); margin-bottom: 8px;">No PHP Versions Installed</h3>
                            <p style="color: var(--text-muted); font-size: 13px;">Click "Install PHP" to add a version.</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = data.versions.map(v => `
                    <div class="list-item" style="padding: 16px 24px;">
                        <div class="service-info">
                            <div class="service-icon php" style="background: linear-gradient(135deg, #8892bf 0%, #4f5b93 100%); width: 36px; height: 36px;">
                                <span style="font-weight: 700; font-size: 12px; color: white;">PHP</span>
                            </div>
                            <div>
                                <div class="service-name">PHP ${v.version}</div>
                                <div class="service-port" style="font-size: 12px; color: var(--text-muted);">${v.path}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            ${v.has_xdebug ? '<span class="status-badge" style="background: var(--success-bg); color: var(--success);">XDebug</span>' : ''}
                            ${v.default ? '<span class="status-badge" style="background: var(--accent-light); color: var(--accent);">Default</span>' : ''}
                            <button class="btn" onclick="setPHPVersion('${v.version}')" ${v.default ? 'disabled' : ''}>
                                ${v.default ? 'Active' : 'Set Default'}
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading PHP versions:', err);
                list.innerHTML = '<div class="empty-state" style="padding: 20px; color: var(--danger);">Error loading PHP versions</div>';
            }
        }

        async function loadStatus() {
            try {
                const data = await api('/status');
                if (data) {
                    document.getElementById('stat-sites').textContent = data.sites || 0;
                    document.getElementById('stat-services').textContent = data.services || 0;
                    document.getElementById('stat-dumps').textContent = data.dumps || 0;
                    document.getElementById('stat-php').textContent = data.php || '-';

                    // Update server status text
                    const statusDot = document.querySelector('.server-status-dot');
                    const statusText = document.getElementById('server-status-text');
                    statusDot.style.background = '#10b981'; // green
                    statusText.textContent = 'Server running on :9999';

                    // Load recent sites
                    const recentSitesEl = document.getElementById('recent-sites');
                    recentSitesEl.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 20px; gap: 12px;">
                            <div class="spinner" style="width: 24px; height: 24px; border-width: 2px;"></div>
                            <span style="color: var(--text-muted); font-size: 11px;">Loading sites...</span>
                        </div>
                    `;
                    const sites = await api('/sites');
                    if (sites && sites.length) {
                        recentSitesEl.innerHTML = sites.slice(0, 5).map(s => `
                            <div class="list-item" style="padding: 12px 16px;">
                                <div class="item-info">
                                <div class="item-primary" style="display: flex; align-items: center; gap: 8px;">
                                        ${s.url.replace(/^https?:\/\//, '')}
                                        ${s.php ? `<span class="site-badge php" style="font-size: 9px; padding: 2px 6px;">PHP ${s.php}</span>` : ''}
                                    </div>
                                    <div class="item-secondary" style="font-size: 12px;">${s.path}</div>
                                </div>
                                <button class="icon-btn" onclick="window.open('${s.url}', '_blank')" title="Open in browser">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                        <polyline points="15 3 21 3 21 9"/>
                                        <line x1="10" y1="14" x2="21" y2="3"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('');
                    } else {
                        recentSitesEl.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No sites configured</div>';
                    }

                    // Load quick services
                    const quickServicesEl = document.getElementById('quick-services');
                    quickServicesEl.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 20px; gap: 12px;">
                            <div class="spinner" style="width: 24px; height: 24px; border-width: 2px;"></div>
                            <span style="color: var(--text-muted); font-size: 11px;">Loading services...</span>
                        </div>
                    `;
                    const servicesData = await api('/services');
                    if (servicesData && servicesData.installed) {
                        const installed = servicesData.installed;
                        if (installed.length) {
                            quickServicesEl.innerHTML = installed.slice(0, 5).map(s => `
                                <div class="list-item" style="padding: 12px 0; border-bottom: none;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="service-icon ${s.type}" style="width: 24px; height: 24px;">
                                            ${getServiceIcon(s.type)}
                                        </div>
                                        <div class="item-info">
                                            <div class="item-primary" style="font-size: 13px; font-weight: 600;">${s.type.toUpperCase()} ${s.version}</div>
                                            <div class="item-secondary" style="font-size: 11px; color: var(--text-muted);">Port: ${s.port || 'Default'}</div>
                                        </div>
                                    </div>
                                    <span class="status-badge status-${s.status}" style="padding: 4px 8px; font-size: 10px; margin-right: 8px;">
                                        <span class="status-dot"></span>${s.status}
                                    </span>
                                    <button class="btn" onclick="${s.status === 'running' ? `stopService('${s.name}')` : `startService('${s.name}')`}" 
                                        style="width: 32px; height: 32px; padding: 0; justify-content: center;" 
                                        title="${s.status === 'running' ? 'Stop' : 'Start'}">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            ${s.status === 'running'
                                    ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'
                                    : '<polygon points="5 3 19 12 5 21 5 3"/>'}
                                        </svg>
                                    </button>
                                </div>
                            `).join('');
                        } else {
                            quickServicesEl.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No services installed yet.</div>';
                        }
                    }
                }
            } catch (err) { console.error(err); }
        }

        // ==========================================
        // Settings & Actions
        // ==========================================

        async function loadSettings() {
            try {
                const prefs = await api('/preferences');
                if (prefs) {
                    const theme = prefs.theme || 'light';
                    document.documentElement.setAttribute('data-theme', theme);
                    document.querySelectorAll('.theme-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.theme === prefs.theme);
                    });
                    document.getElementById('auto-start-toggle').classList.toggle('active', prefs.autoStart);
                    document.getElementById('tray-toggle').classList.toggle('active', prefs.showTray);
                    document.getElementById('port-input').value = prefs.port || 9999;
                    document.getElementById('apache-port-input').value = prefs.apachePort || 80;
                    document.getElementById('nginx-port-input').value = prefs.nginxPort || 80;
                    document.getElementById('mysql-port-input').value = prefs.mysqlPort || 3306;
                    if (document.getElementById('slim-mode-toggle')) {
                        document.getElementById('slim-mode-toggle').classList.toggle('active', prefs.slimMode);
                        setSlimMode(prefs.slimMode);
                    }
                    if (prefs.language) {
                        currentLang = prefs.language;
                        localStorage.setItem('stacker_lang', currentLang);
                        loadTranslations(currentLang);
                    }
                }
            } catch (err) { }
        }

        async function setTheme(theme) {
            try {
                await api('/preferences', 'PUT', { theme });
                document.documentElement.setAttribute('data-theme', theme);
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === theme);
                });
                showToast('Theme changed to ' + theme);
            } catch (err) { showToast(err.message, 'error'); }
        }

        async function toggleAutoStart() {
            const toggle = document.getElementById('auto-start-toggle');
            const newState = !toggle.classList.contains('active');
            try {
                await api('/preferences', 'PUT', { autoStart: newState });
                toggle.classList.toggle('active', newState);
                showToast(newState ? 'Auto-start enabled' : 'Auto-start disabled');
            } catch (err) { showToast(err.message, 'error'); }
        }

        async function toggleTray() {
            const toggle = document.getElementById('tray-toggle');
            const newState = !toggle.classList.contains('active');
            try {
                await api('/preferences', 'PUT', { showTray: newState });
                toggle.classList.toggle('active', newState);
                showToast(newState ? 'Tray icon enabled' : 'Tray icon disabled');
            } catch (err) { showToast(err.message, 'error'); }
        }

        async function toggleSlimMode() {
            const toggle = document.getElementById('slim-mode-toggle');
            const newState = !toggle.classList.contains('active');
            try {
                await api('/preferences', 'PUT', { slimMode: newState });
                toggle.classList.toggle('active', newState);
                setSlimMode(newState);
                showToast(newState ? 'Slim mode enabled' : 'Slim mode disabled');
            } catch (err) { showToast(err.message, 'error'); }
        }

        async function savePorts() {
            const apachePort = parseInt(document.getElementById('apache-port-input').value);
            const nginxPort = parseInt(document.getElementById('nginx-port-input').value);
            const mysqlPort = parseInt(document.getElementById('mysql-port-input').value);

            try {
                await api('/preferences', 'PUT', { apachePort, nginxPort, mysqlPort });
                showToast('Port settings updated (requires service restart)');
            } catch (err) { showToast(err.message, 'error'); }
        }

        async function setPortPreset(type) {
            let apache, nginx, mysql;
            if (type === 'stacker') {
                apache = 80;
                nginx = 81;
                mysql = 3306;
            } else {
                apache = 80;
                nginx = 80;
                mysql = 3306;
            }

            document.getElementById('apache-port-input').value = apache;
            document.getElementById('nginx-port-input').value = nginx;
            document.getElementById('mysql-port-input').value = mysql;

            await savePorts();
        }

        function setSlimMode(enabled) {
            document.body.setAttribute('data-slim', enabled ? 'true' : 'false');
            localStorage.setItem('stacker_slimMode', enabled);
        }

        // Toggle expanded navigation
        function toggleExpandedNav() {
            const toggle = document.getElementById('expanded-nav-toggle');
            const isExpanded = document.body.getAttribute('data-navbar-expanded') === 'true';
            const newState = !isExpanded;

            document.body.setAttribute('data-navbar-expanded', newState ? 'true' : 'false');
            toggle.classList.toggle('active', newState);
            localStorage.setItem('stacker_navExpanded', newState);
            showToast(newState ? 'Navigation expanded' : 'Navigation collapsed');
        }

        // Load slim mode on startup
        (function () {
            const slimMode = localStorage.getItem('stacker_slimMode') === 'true';
            if (slimMode) {
                document.body.setAttribute('data-slim', 'true');
            }

            // Load expanded nav state
            const navExpanded = localStorage.getItem('stacker_navExpanded') === 'true';
            if (navExpanded) {
                document.body.setAttribute('data-navbar-expanded', 'true');
                const toggle = document.getElementById('expanded-nav-toggle');
                if (toggle) toggle.classList.add('active');
            }
        })();

        async function savePort() {
            const port = parseInt(document.getElementById('port-input').value);
            if (port < 1024 || port > 65535) {
                showToast('Port must be between 1024 and 65535', 'error');
                return;
            }
            try {
                await api('/preferences', 'PUT', { port });
                showToast('Port saved! Restart to apply.');
            } catch (err) { showToast(err.message, 'error'); }
        }

        async function checkUpdates() {
            try {
                showToast('Checking for updates...');
                const res = await fetch('https://raw.githubusercontent.com/yasinkuyu/Stacker/main/update.json');
                if (!res.ok) throw new Error('Failed to fetch');
                const data = await res.json();
                const currentVersion = '1.0.1'; // This should match app version
                const remoteVersion = data.stacker.version;
                if (remoteVersion !== currentVersion) {
                    showToast(`New version ${remoteVersion} available!`, 'info');
                    if (await ui.confirm(`New version ${remoteVersion} is available!\n\n${data.stacker.changelog}\n\nWould you like to download it?`)) {
                        window.open(data.stacker.downloadUrl, '_blank');
                    }
                } else {
                    showToast('You are running the latest version');
                }
            } catch (err) {
                showToast('Could not check for updates', 'error');
            }
        }

        // Actions
        async function clearDumps() {
            if (await ui.confirm('Clear all dumps?', { type: 'danger' })) {
                try {
                    await api('/dumps', 'DELETE');
                    loadDumps();
                    showToast('Dumps cleared');
                } catch (err) { showToast(err.message, 'error'); }
            }
        }

        async function clearMail() {
            if (await ui.confirm('Clear all emails?', { type: 'danger' })) {
                try {
                    await api('/mail', 'DELETE');
                    loadMail();
                    showToast('Emails cleared');
                } catch (err) { showToast(err.message, 'error'); }
            }
        }

        async function openTerminal() {
            await api('/open-terminal', 'POST', { path: "" });
        }

        async function setPHPVersion(version) {
            await api('/php/default', 'PUT', { version });
            showToast('PHP version set to ' + version);
            loadPHP();
        }

        // ==========================================
        // Draw Panel Functions
        // ==========================================

        let currentPanel = null;
        let currentSite = null;

        function openDrawPanel(title, content, onSave, saveText = 'Save', wide = false) {
            document.getElementById('drawPanelTitle').textContent = title;
            document.getElementById('drawPanelBody').innerHTML = content;
            document.getElementById('drawPanelOverlay').classList.add('open');
            const panel = document.getElementById('drawPanel');
            panel.classList.add('open');
            if (wide) panel.classList.add('wide');
            else panel.classList.remove('wide');

            const saveBtn = document.getElementById('drawPanelSave');
            saveBtn.style.display = onSave ? 'block' : 'none';
            if (onSave) {
                saveBtn.textContent = saveText;
                saveBtn.onclick = onSave;
            }
            document.getElementById('drawPanelFooter').style.display = 'flex';
            currentPanel = { title, onSave };
        }

        function closeDrawPanel() {
            document.getElementById('drawPanelOverlay').classList.remove('open');
            const panel = document.getElementById('drawPanel');
            panel.classList.remove('open');
            panel.classList.remove('wide');
            currentPanel = null;
            currentSite = null;
        }

        // ==========================================
        // Site Management
        // ==========================================

        async function loadSites() {
            const list = document.getElementById('sites-list');
            try {
                const sites = await api('/sites');

                // Cache sites for panel
                cachedSites = sites || [];

                // Update sites panel
                renderSitesPanelList(cachedSites);
                updateRunningSitesCount();

                if (!sites || !sites.length) {
                    list.innerHTML = '<div class="empty-state"><p>No sites configured</p></div>';
                    return;
                }
                list.innerHTML = sites.map(s => `
                    <div class="site-row">
                        <div class="site-info" onclick='editSite(${JSON.stringify(s)})'>
                            <div class="site-name">${s.url ? s.url.replace(/^https?:\/\//, '') : s.name}</div>
                            <div class="site-path">${s.path}</div>
                        </div>
                        <div class="site-badges">
                            ${s.php ? `<span class="site-badge php">PHP ${s.php}</span>` : ''}
                            ${s.ssl ? '<span class="site-badge ssl">SSL</span>' : ''}
                        </div>
                        <div class="site-actions" style="gap: 4px;">
                            <button class="icon-btn" style="width: 28px; height: 28px; padding: 6px;" onclick="window.open('${s.url}', '_blank')" title="Open"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></button>
                            <button class="icon-btn" style="width: 28px; height: 28px; padding: 6px;" onclick="openSiteFolder('${s.path}')" title="Folder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></button>
                            <button class="icon-btn" style="width: 28px; height: 28px; padding: 6px;" onclick="openSiteTerminal('${s.path}')" title="Terminal"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg></button>
                            <button class="icon-btn" style="width: 28px; height: 28px; padding: 6px;" onclick="openConfigFolder('${s.name}')" title="Config"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/></svg></button>
                            <button class="icon-btn danger" style="width: 28px; height: 28px; padding: 6px;" onclick="deleteSite('${s.name}')" title="Delete"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </div>
                    </div>
                `).join('');
            } catch (err) { }
        }

        async function addSite() {
            const data = await api('/php').catch(() => ({ versions: [] }));
            const phpVersions = data && data.versions ? data.versions : [];
            const phpOptions = phpVersions.map(v =>
                `<option value="${v.version}">PHP ${v.version}${v.default ? ' (Default)' : ''}</option>`
            ).join('');

            const prefs = await api('/preferences').catch(() => ({}));
            const domainExt = prefs.domainExtension || '.local';

            const content = `
                <div class="form-group">
                    <label class="form-label">Site Name</label>
                    <input type="text" class="form-input" id="siteName" placeholder="my-project" oninput="updateSiteHint(this.value, '${domainExt}')">
                    <div class="form-hint" id="siteHint">Will be accessible at my-project${domainExt}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Project Path</label>
                    <div style="display:flex;gap:8px;">
                        <input type="text" class="form-input" id="sitePath" placeholder="/Users/you/Sites/my-project" style="flex:1;">
                        <button class="btn" onclick="browsePath()">Browse</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">PHP Version</label>
                    <select class="form-select" id="sitePhp">
                        <option value="">Use Default</option>
                        ${phpOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div class="settings-row" style="padding:12px 0;border:none;">
                        <div class="settings-info">
                            <div class="settings-label">Enable SSL</div>
                            <div class="settings-desc">Serve site over HTTPS</div>
                        </div>
                        <button class="toggle-switch active" id="siteSsl" onclick="this.classList.toggle('active')"></button>
                    </div>
                </div>
            `;

            openDrawPanel('Add New Site', content, saveSite);
        }

        function updateSiteHint(val, ext) {
            document.getElementById('siteHint').textContent = 'Will be accessible at ' + (val || 'my-project') + ext;
        }

        async function editSite(site) {
            currentSite = site;
            const data = await api('/php').catch(() => ({ versions: [] }));
            const phpVersions = data && data.versions ? data.versions : [];
            const phpOptions = phpVersions.map(v =>
                `<option value="${v.version}" ${site.php === v.version ? 'selected' : ''}>PHP ${v.version}${v.default ? ' (Default)' : ''}</option>`
            ).join('');

            const content = `
                <div class="form-group">
                    <label class="form-label">Site Name</label>
                    <input type="text" class="form-input" id="siteName" value="${site.name}">
                </div>
                <div class="form-group">
                    <label class="form-label">Project Path</label>
                    <input type="text" class="form-input" id="sitePath" value="${site.path}">
                </div>
                <div class="form-group">
                    <label class="form-label">PHP Version</label>
                    <select class="form-select" id="sitePhp">
                        <option value="">Use Default</option>
                        ${phpOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div class="settings-row" style="padding:12px 0;border:none;">
                        <div class="settings-info">
                            <div class="settings-label">Enable SSL</div>
                        </div>
                        <button class="toggle-switch ${site.ssl ? 'active' : ''}" id="siteSsl" onclick="this.classList.toggle('active')"></button>
                    </div>
                </div>
                <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
                    <button class="btn btn-danger" onclick="deleteSite('${site.name}')">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Delete Site
                    </button>
                </div>
            `;

            openDrawPanel('Edit Site: ' + site.name, content, updateSite);
        }

        async function saveSite() {
            const name = document.getElementById('siteName').value.trim();
            const path = document.getElementById('sitePath').value.trim();
            const php = document.getElementById('sitePhp').value;
            const ssl = document.getElementById('siteSsl').classList.contains('active');

            if (!name) {
                showToast('Site name is required', 'error');
                return;
            }

            const btn = document.getElementById('drawPanelSave');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; border-color: white; border-top-color: transparent;"></div> <span>Saving...</span>`;

                await api('/sites', 'POST', { name, path, php, ssl });
                closeDrawPanel();
                showToast('Site added successfully');
                loadSites();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function updateSite() {
            const name = document.getElementById('siteName').value.trim();
            const path = document.getElementById('sitePath').value.trim();
            const php = document.getElementById('sitePhp').value;
            const ssl = document.getElementById('siteSsl').classList.contains('active');

            const btn = document.getElementById('drawPanelSave');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; border-color: white; border-top-color: transparent;"></div> <span>Updating...</span>`;

                await api('/sites/' + currentSite.name, 'PUT', { name, path, php, ssl });
                closeDrawPanel();
                showToast('Site updated successfully');
                loadSites();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function deleteSite(name) {
            if (await ui.confirm('Are you sure you want to delete this site?', { type: 'danger' })) {
                try {
                    await api('/sites/' + name, 'DELETE');
                    closeDrawPanel();
                    showToast('Site deleted');
                    loadSites();
                } catch (err) { showToast(err.message, 'error'); }
            }
        }

        function openSiteInBrowser(name) {
            window.open('https://' + name + '.test', '_blank');
        }

        async function openSiteFolder(path) {
            await api('/open-folder', 'POST', { path });
        }

        async function openSiteTerminal(path) {
            await api('/open-site-terminal', 'POST', { path });
        }

        async function openConfigFolder(siteName) {
            // Open conf/nginx or conf/apache folder (we'll open nginx by default)
            await api('/open-config-folder', 'POST', { siteName });
        }

        async function browsePath() {
            const res = await api('/browse-folder');
            if (res && res.path) {
                document.getElementById('sitePath').value = res.path;
                // If it's a new site and name is empty, try to guess name from path
                const nameInput = document.getElementById('siteName');
                if (nameInput && !nameInput.value) {
                    nameInput.value = res.path.split('/').pop().toLowerCase().replace(/[^a-z0-9]/g, '-');
                }
            }
        }

        async function openTerminal(path = "") {
            // If path is empty string (Default Terminal button), use home or stacker dir
            await api('/open-terminal', 'POST', { path });
        }

        // ==========================================
        // Server Configuration
        // ==========================================

        function openServerConfig() {
            const content = `
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab(this, 'nginx-tab')">Nginx</button>
                    <button class="tab-btn" onclick="switchTab(this, 'mysql-tab')">MySQL</button>
                    <button class="tab-btn" onclick="switchTab(this, 'redis-tab')">Redis</button>
                </div>
                
                <div id="nginx-tab" class="tab-content active">
                    <div class="service-card">
                        <div class="service-info">
                            <div class="service-icon nginx">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="service-name">Nginx</div>
                                <div class="service-port">Port: 80, 443</div>
                            </div>
                        </div>
                        <div class="service-actions">
                            <span class="status-badge status-running"><span class="status-dot"></span>Running</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">HTTP Port</label>
                        <input type="number" class="form-input" id="nginxPort" value="80">
                    </div>
                    <div class="form-group">
                        <label class="form-label">HTTPS Port</label>
                        <input type="number" class="form-input" id="nginxSslPort" value="443">
                    </div>
                </div>
                
                <div id="mysql-tab" class="tab-content">
                    <div class="service-card">
                        <div class="service-info">
                            <div class="service-icon mysql">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/>
                                </svg>
                            </div>
                            <div>
                                <div class="service-name">MySQL</div>
                                <div class="service-port">Port: 3306</div>
                            </div>
                        </div>
                        <div class="service-actions">
                            <button class="toggle-switch active" id="mysqlToggle"></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-input" id="mysqlPort" value="3306">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Root Password</label>
                        <input type="password" class="form-input" id="mysqlPassword" placeholder="">
                    </div>
                </div>
                
                <div id="redis-tab" class="tab-content">
                    <div class="service-card">
                        <div class="service-info">
                            <div class="service-icon redis">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                </svg>
                            </div>
                            <div>
                                <div class="service-name">Redis</div>
                                <div class="service-port">Port: 6379</div>
                            </div>
                        </div>
                        <div class="service-actions">
                            <button class="toggle-switch" id="redisToggle"></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-input" id="redisPort" value="6379">
                    </div>
                </div>
            `;

            openDrawPanel('Server Configuration', content, saveServerConfig);
        }

        function switchTab(btn, tabId) {
            btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        async function saveServerConfig() {
            showToast('Server configuration saved');
            closeDrawPanel();
        }

        // ==========================================
        // PHP Installation
        // ==========================================

        function openInstallPHP() {
            const content = `
                <div style="padding: 16px; text-align: center; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 24px; margin-bottom: 12px;"></div>
                    <div style="font-weight: 600; margin-bottom: 8px;">Install PHP (Standalone)</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Downloads pre-built static PHP binaries. No Homebrew or system dependencies required.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Select PHP Version</label>
                    <select class="form-select" id="installPhpVersion">
                        <option value="8.4">PHP 8.4 (Latest)</option>
                        <option value="8.3" selected>PHP 8.3 (Recommended)</option>
                        <option value="8.2">PHP 8.2 (LTS)</option>
                        <option value="8.1">PHP 8.1</option>
                        <option value="8.0">PHP 8.0</option>
                    </select>
                    <div class="form-hint">PHP will be downloaded from static-php.dev (no external dependencies)</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div class="settings-row" style="padding:12px 0;border:none;">
                        <div class="settings-info">
                            <div class="settings-label">Enable XDebug</div>
                            <div class="settings-desc">Include debugging support (larger download)</div>
                        </div>
                        <button class="toggle-switch" id="installXdebug" onclick="this.classList.toggle('active')"></button>
                    </div>
                </div>

                <div style="padding: 12px; background: var(--success-bg); border-radius: 8px; margin-top: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--success);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 6L9 17l-5-5"/>
                        </svg>
                        <span style="font-weight: 600;">100% Standalone</span>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">No Homebrew, apt, or any package manager needed</div>
                </div>
            `;

            openDrawPanel('Install PHP', content, installPHP, 'Install');
        }

        function copyCommand(command) {
            navigator.clipboard.writeText(command);
            showToast('Command copied to clipboard');
        }

        async function installPHP() {
            const version = document.getElementById('installPhpVersion').value;
            const xdebug = document.getElementById('installXdebug').classList.contains('active');

            // Hide footer during install
            document.getElementById('drawPanelFooter').style.display = 'none';

            // Show progress in panel body
            const body = document.getElementById('drawPanelBody');
            body.innerHTML = `
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Installing PHP ${version}</span>
                        <span id="installPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="installProgressFill"></div>
                    </div>
                    <div class="install-log" id="installLog">
                        Starting download...<br>
                    </div>
                </div>
            `;

            // Start installation
            const btn = document.getElementById('drawPanelSave');
            setButtonLoading(btn, true, 'Installing...');
            try {
                await api('/php/install', 'POST', { version, xdebug });
            } catch (err) {
                setButtonLoading(btn, false);
                showToast(err.message, 'error');
                return;
            }

            // Poll progress
            const log = document.getElementById('installLog');
            const fill = document.getElementById('installProgressFill');
            const perc = document.getElementById('installPercent');

            let progress = 0;
            const interval = setInterval(async () => {
                const status = await api(`/php/install-status?version=${version}`);
                if (status && status.progress !== undefined) {
                    progress = status.progress;

                    // Check for error
                    if (progress === -1) {
                        clearInterval(interval);
                        log.innerHTML += `<span style="color:#ef4444;"> Error: Failed to download PHP ${version}<br>`;
                        log.innerHTML += `<span style="color:#fbbf24;"> Please try a different version or check your internet connection</span><br>`;
                        perc.textContent = 'Error';
                        fill.style.width = '100%';
                        fill.style.background = '#ef4444';
                        return;
                    }

                    fill.style.width = progress + '%';
                    perc.textContent = progress + '%';

                    if (progress > 0 && progress < 100) {
                        log.innerHTML = `Downloading PHP binary... ${progress}%<br>`;
                    } else if (progress === 100) {
                        log.innerHTML += `Extracting files...<br>`;
                        log.innerHTML += `Finalizing installation...<br>`;
                        clearInterval(interval);

                        setTimeout(() => {
                            showToast('PHP ' + version + ' installed successfully');

                            setTimeout(() => {
                                setButtonLoading(btn, false);
                                closeDrawPanel();
                                loadPHP();
                            }, 1000);
                        }, 1000);
                    }
                }
            }, 1000);
        }


        // ==========================================
        // Service Management
        // ==========================================

        let operationModal = null;

        function showOperationProgress(message) {
            operationModal = document.createElement('div');
            operationModal.className = 'modal-overlay';
            operationModal.style.display = 'flex';
            operationModal.innerHTML = `
                <div class="modal" style="max-width: 300px; text-align: center;">
                    <div style="margin-bottom: 16px;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" style="animation: spin 1s linear infinite;">
                            <circle cx="12" cy="12" r="10" stroke-opacity="0.2"/>
                            <path d="M12 2a10 10 0 0 1 10 10"/>
                        </svg>
                    </div>
                    <div style="font-weight: 500;">${message}</div>
                </div>
            `;
            document.body.appendChild(operationModal);
        }

        function hideOperationProgress() {
            if (operationModal) {
                operationModal.remove();
                operationModal = null;
            }
        }

        async function startService(name) {
            showOperationProgress(`Starting ${name}...`);
            try {
                const data = await api('/services');
                const svc = data.installed.find(s => s.name === name);

                await api(`/services/start/${name}`, 'POST');
                hideOperationProgress();
                showToast(`${name} started`);

                if (svc) {
                    showActionProgress(`Starting ${name}`, svc.type, svc.version);
                } else {
                    loadServices();
                }
            } catch (err) {
                hideOperationProgress();
                showToast(err.message, 'error');
            }
        }

        async function stopService(name) {
            showOperationProgress(`Stopping ${name}...`);
            try {
                await api(`/services/stop/${name}`, 'POST');
                hideOperationProgress();
                showToast(`${name} stopped`);
                loadServices();
            } catch (err) {
                hideOperationProgress();
                showToast(err.message, 'error');
            }
        }

        async function restartService(name) {
            showOperationProgress(`Restarting ${name}...`);
            try {
                await api(`/services/restart/${name}`, 'POST');
                hideOperationProgress();
                showToast(`${name} restarted`);
                loadServices();
            } catch (err) {
                hideOperationProgress();
                showToast(err.message, 'error');
            }
        }

        async function editServiceConfig(name) {
            showOperationProgress(`Loading config...`);
            try {
                const config = await api(`/services/config/${name}`);
                hideOperationProgress();
                if (!config || !config.content) {
                    showToast('Config not available', 'error');
                    return;
                }

                openDrawPanel(`Config: ${name}`, `
                    <div style="display: flex; flex-direction: column; height: 100%;">
                        <div style="margin-bottom: 12px; color: var(--text-muted); font-size: 12px;">
                             ${config.path}
                        </div>
                        <textarea id="config-editor" style="flex: 1; width: 100%; min-height: 400px; padding: 12px; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; line-height: 1.5; background: var(--bg-tertiary); color: var(--text); border: 1px solid var(--border); border-radius: 8px; resize: none;">${config.content}</textarea>
                        <div style="margin-top: 12px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn" onclick="closeDrawPanel()">Cancel</button>
                            <button class="btn btn-primary" id="save-config-btn" onclick="saveServiceConfig('${name}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                Save & Restart
                            </button>
                        </div>
                    </div>
                `, null, null, true);
            } catch (err) {
                hideOperationProgress();
                showToast(err.message, 'error');
            }
        }

        async function saveServiceConfig(name) {
            const content = document.getElementById('config-editor').value;
            const btn = document.getElementById('save-config-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"/></svg> Saving...';
            }
            try {
                await api(`/services/config/${name}`, 'POST', { content });
                showToast('Config saved & service restarted');
                closeDrawPanel();
                loadServices();
            } catch (err) {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Save & Restart';
                }
                showToast(err.message, 'error');
            }
        }

        async function uninstallService(name) {
            if (await ui.confirm(`Uninstall ${name}? All data will be lost.`, { type: 'danger' })) {
                try {
                    const data = await api('/services');
                    const svc = data.installed.find(s => s.name === name);

                    await api('/services/uninstall', 'POST', { name });
                    showToast(`${name} uninstallation started...`);

                    if (svc) {
                        showActionProgress(`Uninstalling ${name}`, svc.type, svc.version, true);
                    } else {
                        loadServices();
                        loadStatus();
                    }
                } catch (err) { showToast(err.message, 'error'); }
            }
        }

        function showActionProgress(title, type, version, reloadStatus = false) {
            openDrawPanel(title, `
                <div class="progress-container">
                    <div class="progress-label">
                        <span>${title}</span>
                        <span id="action-percent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="action-fill"></div>
                    </div>
                    <div class="install-log" id="action-log">Processing...</div>
                </div>
            `, null, 'Close');

            const interval = setInterval(async () => {
                const status = await api(`/services/install-status?type=${type}&version=${version}`);
                if (status) {
                    const progress = status.progress;
                    const error = status.error;
                    const log = status.log;

                    if (log) {
                        document.getElementById('action-log').textContent = log;
                    }

                    if (progress === -1) {
                        clearInterval(interval);
                        document.getElementById('action-log').innerHTML = `<span style="color: var(--danger);">Operation failed: ${error || 'Unknown error'}</span>`;
                        return;
                    }
                    document.getElementById('action-fill').style.width = progress + '%';
                    document.getElementById('action-percent').textContent = progress + '%';
                    if (progress === 100) {
                        clearInterval(interval);
                        // If we have a final log message, keep it, otherwise show Completed
                        if (!log) {
                            document.getElementById('action-log').textContent = 'Completed!';
                        } else {
                            // Append Completed to the log or just show log
                            document.getElementById('action-log').textContent = 'Completed! ' + log;
                        }

                        setTimeout(() => {
                            closeDrawPanel();
                            loadServices();
                            if (reloadStatus) loadStatus();
                        }, 1000);
                    }
                }
            }, 800);
        }

        // Show Change Log
        async function showChangeLog() {
            showOperationProgress('Loading changes...');
            try {
                const data = await api('/changelog');
                hideOperationProgress();

                // Parse Markdown
                const lines = data.content.split('\n');
                const history = [];
                let currentVersion = null;

                lines.forEach(line => {
                    const versionMatch = line.match(/^##\s+(v[\d\.]+)\s+\((.+)\)/);
                    if (versionMatch) {
                        if (currentVersion) history.push(currentVersion);
                        currentVersion = {
                            version: versionMatch[1],
                            date: versionMatch[2],
                            type: versionMatch[1].endsWith('.0') ? 'major' : 'minor',
                            changes: []
                        };
                    } else if (currentVersion && line.trim().startsWith('-')) {
                        const changeMatch = line.match(/-\s+\[(\w+)\]\s+(.+)/);
                        if (changeMatch) {
                            currentVersion.changes.push({
                                type: changeMatch[1],
                                text: changeMatch[2]
                            });
                        } else {
                            // Fallback for simple list items
                            currentVersion.changes.push({
                                type: 'misc',
                                text: line.replace('-', '').trim()
                            });
                        }
                    }
                });
                if (currentVersion) history.push(currentVersion);

                const html = history.map(item => `
                    <div class="changelog-item" style="margin-bottom: 32px; position: relative; padding-left: 24px; border-left: 2px solid var(--border-color);">
                        <div style="position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: ${item.type === 'major' ? 'var(--accent)' : 'var(--text-muted)'}; border: 2px solid var(--bg-primary);"></div>
                        <div style="display: flex; align-items: baseline; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 18px; font-weight: 700; color: var(--text-primary);">${item.version}</span>
                            <span style="font-size: 13px; color: var(--text-muted);">${item.date}</span>
                            ${item.type === 'major' ? '<span class="status-badge status-running" style="font-size: 10px;">Major Release</span>' : ''}
                        </div>
                        <ul style="margin: 0; padding: 0; list-style: none;">
                            ${item.changes.map(change => `
                                <li style="margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); display: flex; gap: 8px;">
                                    <span style="
                                        display: inline-flex; align-items: center; justify-content: center;
                                        width: 36px; height: 18px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;
                                        background: ${change.type === 'feat' ? 'rgba(52, 211, 153, 0.1)' : change.type === 'fix' ? 'rgba(248, 113, 113, 0.1)' : 'rgba(96, 165, 250, 0.1)'};
                                        color: ${change.type === 'feat' ? 'rgb(52, 211, 153)' : change.type === 'fix' ? 'rgb(248, 113, 113)' : 'rgb(96, 165, 250)'};
                                    ">${change.type}</span>
                                    <span style="flex: 1; line-height: 1.5;">${change.text}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `).join('');

                openDrawPanel('Change Log', `
                    <div style="padding: 32px 24px;">
                        ${html}
                    </div>
                `);
            } catch (err) {
                hideOperationProgress();
                showToast('Failed to load changelog', 'error');
            }
        }

        async function loadServices() {
            const list = document.getElementById('services-list');

            // Show loading spinner
            list.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; gap: 12px;">
                    <div class="spinner"></div>
                    <span style="color: var(--text-muted); font-size: 13px;">Loading services...</span>
                </div>
            `;

            try {
                const data = await api('/services');
                if (!data) return;

                const installed = data.installed || [];
                const available = data.available || [];
                const systemVersions = data.systemVersions || {};
                const installedVersions = data.installedVersions || [];

                // Cache for panel
                cachedServices = installed;

                // Group available by type and deduplicate
                const availableByType = {};
                const seen = new Set();
                available.forEach(v => {
                    const id = v.type + '-' + v.version;
                    if (seen.has(id)) return;
                    seen.add(id);

                    if (!availableByType[v.type]) availableByType[v.type] = [];
                    const isInstalled = installedVersions.includes(id);
                    availableByType[v.type].push({
                        version: v.version,
                        installed: isInstalled,
                        system_installed: v.system_installed
                    });
                });

                let html = `
                    <div style="padding: 16px;">
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 12px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px;">Installed Services</h3>
                            ${installed.length === 0 ? '<div class="empty-state" style="padding: 16px;"><p>No services installed</p></div>' : installed.map(s => `
                                <div class="service-card">
                                    <div class="service-info">
                                        <div class="service-icon ${s.type}">
                                            ${getServiceIcon(s.type)}
                                        </div>
                                        <div>
                                            <div class="service-name">${s.name} ${s.version}</div>
                                            <div class="service-port">Port: ${s.port || 'Default'}  Status: ${s.status}</div>
                                            ${s.port_in_use && s.status !== 'running' ? `<div style="color: var(--warning); font-size: 11px; margin-top: 4px;"> Port ${s.port} used by: ${s.port_conflict || 'another app'}</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="service-actions">
                                        <span class="status-badge status-${s.status}"><span class="status-dot"></span>${s.status}${s.port_in_use && s.status !== 'running' ? ' (conflict)' : ''}</span>
                                        ${s.runnable !== false ? `
                                        <button class="btn" onclick="${s.status === 'running' ? `stopService('${s.name}')` : `startService('${s.name}')`}" title="${s.status === 'running' ? 'Stop' : 'Start'}">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                ${s.status === 'running' ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>' : '<polygon points="5 3 19 12 5 21 5 3"/>'}
                                            </svg>
                                            ${s.status === 'running' ? 'Stop' : 'Start'}
                                        </button>
                                        ${s.status === 'running' ? `<button class="btn" onclick="restartService('${s.name}')" title="Restart">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                            </svg>
                                        </button>` : ''}
                                        ` : ''}
                                        ${s.has_config ? `<button class="btn" onclick="editServiceConfig('${s.name}')" title="Config">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="3"/>
                                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                            </svg>
                                        </button>` : ''}
                                        ${s.status !== 'running' ? `<button class="btn btn-icon-only btn-danger" onclick="uninstallService('${s.name}')" title="Uninstall">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            </svg>
                                        </button>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div>
                            <h3 style="margin-bottom: 16px; font-size: 14px; text-transform: uppercase; color: var(--text-muted);">Available Services</h3>
                            <div class="card">
                            <div class="card">
                                ${Object.keys(availableByType).map(type => {
                    const availableVersions = availableByType[type];
                    if (availableVersions.length === 0) return '';
                    return `
                                    <div class="list-item" style="padding: 16px 24px;">
                                        <div class="service-info">
                                            <div class="service-icon ${type}" style="width: 36px; height: 36px; font-size: 14px;">
                                                ${getServiceIcon(type)}
                                            </div>
                                            <div>
                                                <div class="service-name" style="text-transform: capitalize;">${type} Server</div>
                                                <div class="service-port">
                                                    ${systemVersions[type] ? `<span style="color: var(--success); font-weight: 500;"> Already installed: v${systemVersions[type]}</span>` : `Available versions: ${availableByType[type].length}`}
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 12px; align-items: center;">
                                            <select class="form-select" id="version-${type}" style="padding: 6px 12px; font-size: 13px; width: 140px;" onchange="checkInstalled('${type}')">
                                                ${availableVersions.map(v => {
                        let suffix = '';
                        if (v.installed) suffix = ' (Installed)';
                        else if (v.system_installed) suffix = ' (System)';
                        return `<option value="${v.version}" ${v.installed ? 'disabled' : ''}>${v.version}${suffix}</option>`;
                    }).join('')}
                                            </select>
                                            <button class="btn btn-primary" onclick="installService('${type}')" style="padding: 8px 20px;" ${systemVersions[type] ? 'disabled' : ''}>
                                                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                                </svg>
                                                Install
                                            </button>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML = html;
            } catch (err) { }
        }

        function checkInstalled(type) {
            // Placeholder for future validation logic
        }

        async function installService(type) {
            const version = document.getElementById(`version-${type}`).value;
            try {
                await api('/services/install', 'POST', { type, version });
                showToast(`Starting installation of ${type} ${version}...`);

                // Show progress in a panel
                openDrawPanel(`Installing ${type}`, `
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Installing ${type} ${version}</span>
                            <span id="svc-install-percent">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="svc-install-fill"></div>
                        </div>
                        <div class="install-log" id="svc-install-log">Starting installation...</div>
                    </div>
                `, null, 'Close');

                const interval = setInterval(async () => {
                    const status = await api(`/services/install-status?type=${type}&version=${version}`);
                    if (status && status.progress !== undefined) {
                        const progress = status.progress;
                        const fillEl = document.getElementById('svc-install-fill');
                        const percEl = document.getElementById('svc-install-percent');
                        const logEl = document.getElementById('svc-install-log');

                        if (progress === -1) {
                            clearInterval(interval);
                            const errorMsg = status.error || 'Unknown error';
                            if (logEl) logEl.innerHTML = `<span style="color: var(--danger);">Installation failed: ${errorMsg}</span>`;
                            return;
                        }
                        if (fillEl) fillEl.style.width = progress + '%';
                        if (percEl) percEl.textContent = progress + '%';
                        if (progress === 100) {
                            clearInterval(interval);
                            if (logEl) logEl.textContent = 'Installation complete!';
                            setTimeout(() => {
                                closeDrawPanel();
                                loadServices();
                            }, 1500);
                        }
                    }
                }, 1000);

            } catch (err) { showToast(err.message, 'error'); }
        }

        // ==========================================
        // Data Viewing
        // ==========================================

        async function loadDumps() {
            const list = document.getElementById('dumps-list');
            try {
                const data = await api('/dumps');
                if (!data || !data.dumps || !data.dumps.length) {
                    list.innerHTML = '<div class="empty-state"><p>No dumps recorded</p></div>';
                    return;
                }
                list.innerHTML = data.dumps.map(d => `
                    <div class="list-item" onclick="viewDump('${d.id}')" style="cursor: pointer;">
                        <div class="item-info">
                            <div class="item-primary">${d.file}:${d.line}</div>
                            <div class="item-secondary">${d.site || 'Unknown'}</div>
                        </div>
                        <span class="item-secondary">${new Date(d.timestamp).toLocaleString()}</span>
                    </div>
                `).join('');
            } catch (err) { }
        }

        async function viewDump(id) {
            try {
                const data = await api('/dumps');
                const dump = data.dumps.find(d => d.id === id);
                if (dump) {
                    openDrawPanel('Dump Details', `<pre style="padding:16px;background:#1e1e1e;color:#fff;overflow:auto;">${JSON.stringify(dump.data, null, 2)}</pre>`, null, 'Close');
                }
            } catch (err) { }
        }

        async function loadMail() {
            const list = document.getElementById('mail-list');
            try {
                const emails = await api('/mail');
                if (!emails || !emails.length) {
                    list.innerHTML = '<div class="empty-state"><p>No emails received</p></div>';
                    return;
                }
                list.innerHTML = emails.map(e => `
                    <div class="list-item" onclick="viewEmail('${e.id}')" style="cursor: pointer;">
                        <div class="item-info">
                            <div class="item-primary">${e.subject}</div>
                            <div class="item-secondary">From: ${e.from}</div>
                        </div>
                    </div>
                `).join('');
            } catch (err) { }
        }

        async function loadLogs() {
            const list = document.getElementById('logs-list');
            try {
                const logs = await api('/logs');
                if (!logs || !logs.length) {
                    list.innerHTML = '<div class="empty-state"><p>No log files found</p></div>';
                    return;
                }
                list.innerHTML = logs.map(l => `
                    <div class="list-item" onclick="viewLog('${l.path || l.name}')" style="cursor: pointer;">
                        <div class="item-info">
                            <div class="item-primary">${l.name}</div>
                        </div>
                    </div>
                `).join('');
            } catch (err) { }
        }

        async function viewEmail(id) {
            try {
                const emails = await api('/mail');
                const email = emails.find(e => e.id === id);
                if (email) {
                    openDrawPanel('Email: ' + email.subject, `<div style="padding:16px;">
                        <div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);">
                            <div><strong>From:</strong> ${email.from}</div>
                            <div><strong>To:</strong> ${email.to}</div>
                            <div><strong>Date:</strong> ${new Date(email.timestamp).toLocaleString()}</div>
                        </div>
                        <div style="white-space:pre-wrap;">${email.body || email.html}</div>
                    </div>`, null, 'Close');
                }
            } catch (err) { showToast('Could not load email', 'error'); }
        }

        async function viewLog(path) {
            showOperationProgress('Loading log...');
            try {
                const logs = await api('/logs/view?path=' + encodeURIComponent(path) + '&lines=2000');
                hideOperationProgress();
                if (logs && logs.content) {
                    const lines = logs.content.split('\n');
                    const totalLines = lines.length;
                    let filteredLines = lines;
                    let searchTerm = '';

                    const renderLogContent = () => {
                        let html = filteredLines.map((line, i) => {
                            let displayLine = line.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            // Highlight search term
                            if (searchTerm) {
                                const regex = new RegExp('(' + searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                                displayLine = displayLine.replace(regex, '<mark style="background:#ffd54f;color:#000;padding:0 2px;border-radius:2px;">$1</mark>');
                            }
                            // Highlight error/warning keywords
                            if (/error|fatal|critical/i.test(line)) {
                                return `<div style="color:#ff6b6b;background:rgba(255,107,107,0.1);padding:2px 8px;margin:1px 0;border-left:3px solid #ff6b6b;">${displayLine}</div>`;
                            } else if (/warn/i.test(line)) {
                                return `<div style="color:#ffd93d;background:rgba(255,217,61,0.1);padding:2px 8px;margin:1px 0;border-left:3px solid #ffd93d;">${displayLine}</div>`;
                            } else if (/info|notice/i.test(line)) {
                                return `<div style="color:#4ecdc4;padding:2px 8px;">${displayLine}</div>`;
                            }
                            return `<div style="padding:2px 8px;">${displayLine}</div>`;
                        }).join('');
                        document.getElementById('log-content').innerHTML = html;
                    };

                    const panelContent = `
                        <div style="display:flex;flex-direction:column;height:100%;">
                            <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;">
                                <div style="position:relative;flex:1;">
                                    <input type="text" id="log-search" placeholder="Search logs..." style="width:100%;padding:8px 12px 8px 36px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
                                    <svg style="position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:0.5;" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                                </div>
                                <span id="log-match-count" style="font-size:12px;color:var(--text-muted);min-width:80px;"></span>
                                <button class="btn" onclick="document.getElementById('log-content').scrollTop = document.getElementById('log-content').scrollHeight" title="Jump to end">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
                                    Tail
                                </button>
                            </div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
                                 ${path}  ${totalLines.toLocaleString()} lines
                            </div>
                            <div id="log-content" style="flex:1;overflow:auto;background:#1e1e1e;border-radius:8px;font-family:'SF Mono',Monaco,monospace;font-size:12px;line-height:1.4;color:#d4d4d4;max-height:calc(100vh - 220px);"></div>
                        </div>
                    `;

                    openDrawPanel('Log: ' + path.split('/').pop(), panelContent, null, 'Close', true);
                    renderLogContent();

                    // Auto-scroll to end
                    setTimeout(() => {
                        const content = document.getElementById('log-content');
                        if (content) content.scrollTop = content.scrollHeight;
                    }, 100);

                    // Search functionality
                    document.getElementById('log-search').addEventListener('input', (e) => {
                        searchTerm = e.target.value;
                        if (searchTerm) {
                            filteredLines = lines.filter(line => line.toLowerCase().includes(searchTerm.toLowerCase()));
                            document.getElementById('log-match-count').textContent = filteredLines.length + ' matches';
                        } else {
                            filteredLines = lines;
                            document.getElementById('log-match-count').textContent = '';
                        }
                        renderLogContent();
                    });
                }
            } catch (err) {
                hideOperationProgress();
                showToast('Could not load log file', 'error');
            }
        }

        // ==========================================
        // Initialization
        // ==========================================

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('server-status-text').textContent = 'Server running on :' + window.location.port;
            if (!window.location.hash) {
                window.location.hash = '#dashboard';
            }
            const hash = window.location.hash.slice(1) || 'dashboard';
            showPage(hash);
            loadStatus();
            loadSettings();
            setInterval(loadStatus, 10000);
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDrawPanel();
        });

        // Panel Search Functionality
        document.getElementById('panelSearch')?.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const activeNav = document.querySelector('.nav-item.active')?.getAttribute('onclick');

            if (activeNav && activeNav.includes('sites')) {
                renderSitesPanelList(query);
            } else if (activeNav && activeNav.includes('services')) {
                renderServicesPanelList(query);
            } else if (activeNav && activeNav.includes('php')) {
                renderPHPPanelList(query);
            } else if (activeNav && activeNav.includes('dumps')) {
                renderDumpsPanelList(query);
            }
        });
    </script>
</body>

</html>